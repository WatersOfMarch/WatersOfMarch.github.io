<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/google.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon%20.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="123456  .   ____          _            __ _ _ &#x2F;\\ &#x2F; ___&amp;#x27;_ __ _ _(_)_ __  __ _ \ \ \ \( ( )\___ | &amp;#x27;_ | &amp;#x27;_| | &amp;#x27;_ \&#x2F; _&#96; | \ \ \ \ \\&#x2F;  ___)| |_)| | | | | || (_| |  ) ) ) )  &amp;#x27;  |_">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="http://example.com/2022/09/27/SpringCloud/index.html">
<meta property="og:site_name" content="散人阿畅">
<meta property="og:description" content="123456  .   ____          _            __ _ _ &#x2F;\\ &#x2F; ___&amp;#x27;_ __ _ _(_)_ __  __ _ \ \ \ \( ( )\___ | &amp;#x27;_ | &amp;#x27;_| | &amp;#x27;_ \&#x2F; _&#96; | \ \ \ \ \\&#x2F;  ___)| |_)| | | | | || (_| |  ) ) ) )  &amp;#x27;  |_">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/1661307288619_7B458813-F654-473a-A494-94ADE8CA6F89.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824102603.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906104143705.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824103855.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824104359.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824104818.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824105758.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824161925.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824162214.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824162332.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824162436.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824162615.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824162952.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824162912.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220824164851.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220826090714.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220826090751.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220826091057.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220826094119.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220826094206.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829091535923.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829091545876.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829091610705.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829103904955.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829105717430.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829110507456.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829110908379.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829143940939.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829144448634.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829150325562.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829154514651.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829155336240.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829161634237.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829161807860.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829161910496.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220829170936143.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830095125327.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830094139380.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830094539713.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830100617223.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830100725735.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830100745261.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830100840371.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830111230924.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830111309396.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830145141623.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830150807223.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830155138463.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830155451222.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830155911198.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830161104155.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830161247935.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830162636677.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830163031671.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830163044516.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830163114476.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831132018155.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830194022234.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830194412111.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830194952818.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830195245720.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830195318203.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830195542321.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220830195605928.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831112138825.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831112437481.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831112451743.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831135657289.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831140310971.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831140422862.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831141538329.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220831150808413.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902090547076.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902092304620.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902093934658.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902094214985.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902155947402.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902160017193.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902160105554.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902160215632.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220902160341024.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220905091222052.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220905091747093.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220905091802113.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220905091848320.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220905104006516.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220905104416423.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220905104724771.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906165435093.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906190830406.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906191202261.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906191906784.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906191630967.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906191716372.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906192926893.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906194520853.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220906202010221.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220907153019499.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220907153454719.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220910104355945.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220910104913398.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220910105142422.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220910105758746.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220910212843581.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220910213033768.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220910214538911.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220910214907841.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220911094344427.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220911094813062.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220911094755040.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220911111517704.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220911111900321.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913093731894.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913094043989.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913094720084.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913101004935.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913102718120.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913102823561.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913135545890.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913135707530.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913140036839.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913135850157.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913151240191.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913151302799.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913151506352.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913151626374.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913151649816.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913153223459.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913162245171.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913164018159.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913164136533.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913164218779.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913164632728.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913164942675.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913165012084.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220913165053249.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914092459847.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914094157504.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914102528926.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914111750199.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914112001175.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914141745044.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914142144565.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914142455266.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914142622963.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914142825008.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914142843243.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914143713912.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914152205782.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914153858596.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914153957448.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914154014752.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914182556731.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914183425573.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914191618007.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914185803489.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914190132655.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220914192656106.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220915102209467.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220915103140241.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220915112337654.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220915103228782.png">
<meta property="og:image" content="d:/Typora/images/image-20220915103255817.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220915144556950.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220916145617320.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919092659451.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919093818379.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919101013778.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919101043845.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919101553918.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919163535543.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919164846437.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919165343013.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919165409551.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919190446834.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919191215337.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919191532515.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919191557173.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919191923670.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919193604606.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919193246798.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919193804706.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919194743940.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919194752736.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220919194840893.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920102721472.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920102853858.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920103015574.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920103038835.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920140404693.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920140841727.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920142126064.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920142311167.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920144757836.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920144904376.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920145122956.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220920145958869.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921111949481.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921092029629.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921092109404.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921092158393.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921093001459.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921093140109.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921105209346.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921105723620.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921105511915.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921111429650.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921112104705.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921112233585.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921112747601.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921112723376.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921135949238.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921140806272.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921145852227.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921145729390.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921162013141.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220921162232625.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220922103752093.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220922153424783.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220922154206331.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220922155757350.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923094656289.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923095115034.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923101532204.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923101707345.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923103552569.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923105245997.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923104810531.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923110731919.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923111530999.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923134330816.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923144309319.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923153843310.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923153854007.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923155510881.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220923161040379.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926093105136.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926094236294.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926093317513.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926100325572.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926100905503.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926144953921.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926152535585.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926152832895.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926155734168.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926160212152.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926160342379.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926172022503.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926171953487.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926171909231.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926172242332.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220926172259629.png">
<meta property="og:image" content="http://example.com/2022/09/27/SpringCloud/image-20220927101736657.png">
<meta property="article:published_time" content="2022-09-27T08:14:57.000Z">
<meta property="article:modified_time" content="2022-09-27T08:49:23.306Z">
<meta property="article:author" content="散人阿畅">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/09/27/SpringCloud/1661307288619_7B458813-F654-473a-A494-94ADE8CA6F89.png">

<link rel="canonical" href="http://example.com/2022/09/27/SpringCloud/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringCloud | 散人阿畅</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">散人阿畅</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">忍过事堪喜</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/27/SpringCloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E7%BD%97%E5%B0%8F%E9%BB%91.jpg">
      <meta itemprop="name" content="散人阿畅">
      <meta itemprop="description" content="浮舟沧海，立马昆仑">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="散人阿畅">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCloud
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-27 16:14:57 / 修改时间：16:49:23" itemprop="dateCreated datePublished" datetime="2022-09-27T16:14:57+08:00">2022-09-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>SpringCloud微服务架构</p>
<h2 id="一、基础概念"><a href="#一、基础概念" class="headerlink" title="一、基础概念"></a>一、基础概念</h2><p>基于分布式的微服务架构—整体架构<br><img src="/2022/09/27/SpringCloud/1661307288619_7B458813-F654-473a-A494-94ADE8CA6F89.png"></p>
<p><strong>分布式的整体维度：</strong></p>
<ul>
<li>服务注册与发现</li>
<li>服务调用</li>
<li>服务熔断</li>
<li>负载均衡</li>
<li>服务降级</li>
<li>服务消息队列</li>
<li>配置中心管理</li>
<li>服务网关</li>
<li>服务监控</li>
<li>全链路追踪</li>
<li>自动化构建部署</li>
<li>服务定时任务调度操作</li>
</ul>
<h3 id="1-SpringCloud简介"><a href="#1-SpringCloud简介" class="headerlink" title="1.SpringCloud简介"></a>1.SpringCloud简介</h3><pre><code>SpringCloud=分布式微服务架构的一站式解决方案，是多种微服务架构落地技术的集合体，俗称微服务全家桶
</code></pre>
<p>由n多个springboot组成</p>
<h3 id="2-基本使用技术"><a href="#2-基本使用技术" class="headerlink" title="2.基本使用技术"></a>2.基本使用技术</h3><p>（2020.2之后每部分技术都有所更新）</p>
<p><img src="/2022/09/27/SpringCloud/image-20220824102603.png" alt="image-20220824102603"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220906104143705.png" alt="image-20220906104143705"></p>
<h3 id="3-版本选择"><a href="#3-版本选择" class="headerlink" title="3.版本选择"></a>3.版本选择</h3><p>SpringBoot版本使用数字标识<br>SpringCloud版本使用字母标识（采用伦敦地铁站的名字命名）</p>
<p>由 SpringCloud 版本选择 SpringBoot版本</p>
<p><strong>boot 和 cloud 适配的版本</strong><br><img src="/2022/09/27/SpringCloud/image-20220824103855.png"><br>按照官网给的标准来（解析json)<br><a target="_blank" rel="noopener" href="https://start.spring.io/actuator/info">https://start.spring.io/actuator/info</a><br><img src="/2022/09/27/SpringCloud/image-20220824104359.png"></p>
<h3 id="4-教程使用版本"><a href="#4-教程使用版本" class="headerlink" title="4.教程使用版本"></a>4.教程使用版本</h3><p><img src="/2022/09/27/SpringCloud/image-20220824104818.png"></p>
<h3 id="5-组件停更说明"><a href="#5-组件停更说明" class="headerlink" title="5.组件停更说明"></a>5.组件停更说明</h3><p>基本全部组件停更不停用，有新的组件去替换<br><img src="/2022/09/27/SpringCloud/image-20220824105758.png"></p>
<h3 id="SpringCloud-中文知道手册"><a href="#SpringCloud-中文知道手册" class="headerlink" title="SpringCloud 中文知道手册"></a>SpringCloud 中文知道手册</h3><p><a target="_blank" rel="noopener" href="https://www.springcloud.cc/spring-cloud-greenwich.html#_spring_cloud_context_application_context_services">Spring Cloud Greenwich 中文文档 参考手册 中文版</a></p>
<h2 id="二、聚合父工程"><a href="#二、聚合父工程" class="headerlink" title="二、聚合父工程"></a>二、聚合父工程</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>1.新建项目，选择Maven版本<br><img src="/2022/09/27/SpringCloud/image-20220824161925.png"></p>
<p>2.字符编码<br><img src="/2022/09/27/SpringCloud/image-20220824162214.png"></p>
<p>3.注解生效激活<br><img src="/2022/09/27/SpringCloud/image-20220824162332.png"></p>
<p>4.Java版本选8<br><img src="/2022/09/27/SpringCloud/image-20220824162436.png"></p>
<p>5.file type 过滤<br><img src="/2022/09/27/SpringCloud/image-20220824162615.png"></p>
<h3 id="父工程pom文件"><a href="#父工程pom文件" class="headerlink" title="父工程pom文件"></a>父工程pom文件</h3><p>删掉生成的src文件夹<br><img src="/2022/09/27/SpringCloud/image-20220824162952.png"></p>
<p>1.修改打包方式为pom (默认是jar)<br><img src="/2022/09/27/SpringCloud/image-20220824162912.png"></p>
<p>2.统一jar包版本<br>3.配置 dependencyManagement</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 统一管理 jar 包版本 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.21<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">mybatis.spring.boot.version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">mybatis.spring.boot.version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">&lt;!-- 子块基础之后，提供作用(并不是引入依赖，子类还需自己导入需要的依赖)：锁定版本 + 子module不用写 groupId 和 version --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- 下面三个基本是微服务架构的标配 --&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--spring boot 2.2.2--&gt;</span>    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>  </span><br><span class="line">      <span class="comment">&lt;!--scope=import 来实现多继承--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--spring cloud Hoxton.SR1--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--spring cloud 阿里巴巴--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!--mysql--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- druid--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--junit 单元测试--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--log4j--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果导入的依赖爆红，先把 dependencyManagement 注释掉再导入(因为dependencyManagement只是锁定版本)<br>需要修改的话，就是改变三个标配的版本</p>
<p>通常在最顶层的父 pom 会看到 dependencyManagement<br>Maven会沿着父子层次向上走，直到找到一个拥有 dependencyManagement 元素的项目，然后会使用这个 dependencyManagement 元素中指定的版本号<br><em>如果子项目需要其他版本，自己加version即可</em></p>
<p><font color="red">dependencyManagement 里只声明依赖，并不实现引入；只有在子项目中写入该依赖，并没有指定具体版本，才会从父项目中继承该项。并且version和scope都读取自父pom</font></p>
<p>跳过测试单元<br><img src="/2022/09/27/SpringCloud/image-20220824164851.png"></p>
<h2 id="三、构建支付模块"><a href="#三、构建支付模块" class="headerlink" title="三、构建支付模块"></a>三、构建支付模块</h2><p>微服务模块：</p>
<ol>
<li>建module</li>
<li>改POM</li>
<li>写YML</li>
<li>主启动</li>
<li>业务类</li>
</ol>
<h3 id="1-建moudle"><a href="#1-建moudle" class="headerlink" title="1. 建moudle"></a>1. 建moudle</h3><p><img src="/2022/09/27/SpringCloud/image-20220826090714.png" alt="image-20220826090714"><br>选择maven项目<br><img src="/2022/09/27/SpringCloud/image-20220826090751.png"></p>
<p>查看父pom发现已有改变<br><img src="/2022/09/27/SpringCloud/image-20220826091057.png"></p>
<h3 id="2-改子类的pom"><a href="#2-改子类的pom" class="headerlink" title="2. 改子类的pom"></a>2. 改子类的pom</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!--        web启动器--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!--        监控接口、健康检测--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!--        这里写了版本号就用子类的，没写就使用父类的--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-配置yml文件-自己新建"><a href="#3-配置yml文件-自己新建" class="headerlink" title="3. 配置yml文件(自己新建)"></a>3. 配置yml文件(自己新建)</h3><p><img src="/2022/09/27/SpringCloud/image-20220826094119.png"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span>  </span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span>  </span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">application:</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span>  </span><br><span class="line">  <span class="attr">datasource:</span>  </span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span>   <span class="comment"># 当前数据源操作类型  </span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span>    <span class="comment"># mysql驱动包  </span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/reboot?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;serverTimezone=UTC</span>  </span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span>  </span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span>  </span><br><span class="line">  </span><br><span class="line"><span class="attr">mybatis:</span>  </span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/*.xml</span>  </span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.atguigu.springcloud.entities</span>  <span class="comment"># 所有entity别名类所在包</span></span><br></pre></td></tr></table></figure>

<h3 id="4-写启动类"><a href="#4-写启动类" class="headerlink" title="4. 写启动类"></a>4. 写启动类</h3><p><img src="/2022/09/27/SpringCloud/image-20220826094206.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain8001</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        SpringApplication.run(PaymentMain8001.class,args);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-业务类"><a href="#5-业务类" class="headerlink" title="5.业务类"></a>5.业务类</h3><p><strong>1&gt;  创数据库和表</strong></p>
<p><img src="/2022/09/27/SpringCloud/image-20220829091535923.png" alt="image-20220829091535923"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220829091545876.png" alt="image-20220829091545876"></p>
<p><strong>2&gt;  创建实体类</strong></p>
<p>主实体Payment</p>
<p>json封装体CommonResult</p>
<p><img src="/2022/09/27/SpringCloud/image-20220829091610705.png" alt="image-20220829091610705"></p>
<p>实现 Serializable 对象序列化接口；作用：</p>
<ol>
<li>便于存储</li>
<li>便于传输</li>
<li>保障数据可读性；（内存不够时，暂时存储到硬盘中）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="comment">// Serializable 对象序列化的接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Payment</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123; <span class="comment">// 实体类序列化（后头分布式中要用到）</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String serial;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommonResult</span><span class="params">(Integer code,String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(code,message,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>3&gt;  dao</strong></p>
<p>@Mapper   Apache的，推荐使用</p>
<p>@Repository   spring的，容易出现问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">(Payment payment)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Payment <span class="title">getPaymentById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>XML文件</p>
<p>namespace —- 强调关联到哪个dao</p>
<p>parameterType  —-  映射实体类（传参）  可传Java对象，数组，map…</p>
<p>useGeneratedKeys  —–  返回一个数字，成功—1；失败—0</p>
<p><resultMap>  映射数据库和Java实体类</resultMap></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;order_status&quot;</span> <span class="attr">property</span>=<span class="string">&quot;orderStatus&quot;</span> <span class="attr">javaType</span>=<span class="string">&quot;INT&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>字段名 —- 变量名 —- 类型（类型有的时候加了会报错）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.springcloud.dao.PaymentDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Payment 为自定义的实体类--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;create&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Payment&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        insert into payment(serial) values (#&#123;serial&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.atguigu.springcloud.entities.Payment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;serial&quot;</span> <span class="attr">property</span>=<span class="string">&quot;serial&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getPaymentById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">        select * from payment where id=#&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>4&gt;  service</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">(Payment payment)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Payment <span class="title">getPaymentById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentServiceImpl</span> <span class="keyword">implements</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 和 @Autowired 一样也是自动装填，但 Resource 是Java自己的方法</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentDao paymentDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">(Payment payment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentDao.create(payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Payment <span class="title">getPaymentById</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentDao.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>5&gt;  controller</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写操作 post</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/payment/create&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> Payment payment)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  int 是因为有 useGeneratedKeys 成功返回1，失败返回0</span></span><br><span class="line">        <span class="keyword">int</span> result = paymentService.create(payment);</span><br><span class="line">        log.info(<span class="string">&quot;***插入结果：&quot;</span>+result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span>  CommonResult(<span class="number">200</span>,<span class="string">&quot;插入成功&quot;</span>,result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">444</span>,<span class="string">&quot;插入失败&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读操作 get</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        Payment payment = paymentService.getPaymentById(id);</span><br><span class="line">        log.info(<span class="string">&quot;***插入结果：&quot;</span>+payment);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (payment != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span>  CommonResult(<span class="number">200</span>,<span class="string">&quot;查询成功&quot;</span>,payment);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">444</span>,<span class="string">&quot;没有对应记录,查询ID：&quot;</span>+id,<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>6&gt;  测试</strong></p>
<p>浏览器可支持Get请求，但不太支持Post请求，需要使用postma</p>
<p>测就完了</p>
<p><img src="/2022/09/27/SpringCloud/image-20220829103904955.png" alt="image-20220829103904955"></p>
<h3 id="6-热部署Devtools"><a href="#6-热部署Devtools" class="headerlink" title="6.热部署Devtools"></a>6.热部署Devtools</h3><p>部署后就不需要每次修改完项目都手动重启</p>
<p><font color="red">只在开发测试阶段使用，上线后关闭</font></p>
<p>1&gt;  添加依赖（在子工程的pom文件中）</p>
<p><scope>  指定了依赖（第三方jar包）的 <strong>作用范围</strong></scope></p>
<p><optional>  A项目添加该选项后，在B中就不会出现此依赖，除非删掉或写为false</optional></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2&gt;  添加插件到父工程 pom 中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3&gt;  开启自动编译选项</p>
<p><img src="/2022/09/27/SpringCloud/image-20220829105717430.png" alt="image-20220829105717430"></p>
<p>4&gt;  更新值</p>
<p>Ctrl + Shift + Alt + /</p>
<p>选择 Register</p>
<p><img src="/2022/09/27/SpringCloud/image-20220829110507456.png" alt="image-20220829110507456"></p>
<p>2021新版 compiler automake allow when app running  移到setting里了</p>
<p><img src="/2022/09/27/SpringCloud/image-20220829110908379.png" alt="image-20220829110908379"></p>
<p>5&gt;  重启 idea</p>
<h2 id="四、客户端（在cloud下创建另一个工程）"><a href="#四、客户端（在cloud下创建另一个工程）" class="headerlink" title="四、客户端（在cloud下创建另一个工程）"></a>四、客户端（在cloud下创建另一个工程）</h2><h3 id="1-还是老样子，5步走"><a href="#1-还是老样子，5步走" class="headerlink" title="1. 还是老样子，5步走"></a>1. 还是老样子，5步走</h3><ol>
<li>建 moudle</li>
<li>导 pom</li>
<li>写 yml</li>
<li>写启动类</li>
<li>业务类</li>
</ol>
<p><img src="/2022/09/27/SpringCloud/image-20220829143940939.png" alt="image-20220829143940939"></p>
<p>pom.xml 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        web启动器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        监控接口--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8002</span></span><br></pre></td></tr></table></figure>

<p>主启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMain8002</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderMain8002.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>把实体类的内容从8001项目里copy过来，创建controller</p>
<p><img src="/2022/09/27/SpringCloud/image-20220829144448634.png" alt="image-20220829144448634"></p>
<h3 id="2-配置RestTemplat"><a href="#2-配置RestTemplat" class="headerlink" title="2. 配置RestTemplat"></a>2. 配置RestTemplat</h3><p>该项目的目的是调用8001端口，来实现客户端的功能</p>
<p><strong>RestTemplat：</strong>提供了多种便捷访问远程Http服务的方法；是一种简单便捷的访问restful服务模板类，是Spring提供的用于访问Rest服务的<strong>客户端模板工具集</strong></p>
<p><img src="/2022/09/27/SpringCloud/image-20220829150325562.png" alt="image-20220829150325562"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-业务类"><a href="#3-业务类" class="headerlink" title="3. 业务类"></a>3. 业务类</h3><p>只要一个controller就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PAYMENT_URL = <span class="string">&quot;http://localhost:8001&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/create&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">create</span><span class="params">(Payment payment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(PAYMENT_URL + <span class="string">&quot;/payment/create&quot;</span>,payment,CommonResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(PAYMENT_URL+<span class="string">&quot;/payment/get/&quot;</span>+id,CommonResult.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>postman测试</p>
<p><img src="/2022/09/27/SpringCloud/image-20220829154514651.png" alt="image-20220829154514651"></p>
<h3 id="4-启动多个微服务"><a href="#4-启动多个微服务" class="headerlink" title="4. 启动多个微服务"></a>4. 启动多个微服务</h3><p><img src="/2022/09/27/SpringCloud/image-20220829155336240.png" alt="image-20220829155336240"></p>
<h2 id="五、工程重构"><a href="#五、工程重构" class="headerlink" title="五、工程重构"></a>五、工程重构</h2><h3 id="1-问题"><a href="#1-问题" class="headerlink" title="1. 问题"></a>1. 问题</h3><p>多个工程有很多相同的部分，比如实体类，大家都要用到，所以为了避免冗余，可以集成到一个项目中</p>
<h3 id="2-创建新-moudle"><a href="#2-创建新-moudle" class="headerlink" title="2. 创建新 moudle"></a>2. 创建新 moudle</h3><p><img src="/2022/09/27/SpringCloud/image-20220829161634237.png" alt="image-20220829161634237"></p>
<h3 id="3-改-pom-依赖"><a href="#3-改-pom-依赖" class="headerlink" title="3. 改 pom 依赖"></a>3. 改 pom 依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        HuTool工具包(一个非常好用的工具包)--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.4.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-把entities粘贴过来"><a href="#4-把entities粘贴过来" class="headerlink" title="4. 把entities粘贴过来"></a>4. 把entities粘贴过来</h3><p><img src="/2022/09/27/SpringCloud/image-20220829161807860.png" alt="image-20220829161807860"></p>
<h3 id="5-maven命令-clean，install"><a href="#5-maven命令-clean，install" class="headerlink" title="5. maven命令 clean，install"></a>5. maven命令 clean，install</h3><p>点闪电符号跳过测试模块</p>
<p><img src="/2022/09/27/SpringCloud/image-20220829161910496.png" alt="image-20220829161910496"></p>
<h3 id="6-删除8001、8002两个项目的entities；并在各自pom中导入依赖"><a href="#6-删除8001、8002两个项目的entities；并在各自pom中导入依赖" class="headerlink" title="6. 删除8001、8002两个项目的entities；并在各自pom中导入依赖"></a>6. 删除8001、8002两个项目的entities；并在各自pom中导入依赖</h3><p>maven install 是把自定义的maven项目导入到本地仓库</p>
<p>导入新建的maven项目</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>8001和8002的pom都要导入，然后可以删除实体类的文件夹了</strong></p>
<p>启动后，测试——-没有问题</p>
<h2 id="六、-Eureka-服务注册与发现"><a href="#六、-Eureka-服务注册与发现" class="headerlink" title="六、 Eureka 服务注册与发现"></a>六、 Eureka 服务注册与发现</h2><h3 id="1、-Eureka基础知识"><a href="#1、-Eureka基础知识" class="headerlink" title="1、 Eureka基础知识"></a>1、 Eureka基础知识</h3><p>Eurkea采用C/S的设计架构</p>
<p>避免单点故障，所以使用集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">什么是服务治理：</span><br><span class="line">	springcloud封装了Netflix公司开发的Eureka模块来实现服务治理</span><br><span class="line">	</span><br><span class="line">当客户端和服务端过多时，管理每个服务之间的依赖关系比较复杂，需要使用服务治理。可以实现服务调用、负载均衡、容错等</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220829170936143.png" alt="image-20220829170936143"></p>
<p>系统中的其他微服务，使用 Eureka 的客户端连接到 Eureka Server 并维持心跳连接</p>
<p>客户端好比学生，服务端集群好比老师们 Eureka Client，Eureka Server 就是学校；心跳接口就是学校会看老师和学生是否在正常上课          学生也可以作为 Eureka Client 注册到学校，然后找老师们寻求服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“心跳”指的是一段定时发送的自定义信息，让对方知道自己“存活”，以确保连接的有效性。大部分 CS 架构的应用程序都采用了心跳机制，服务端和客户端都可以发心跳。通常情况下是客户端向服务器端发送心跳包，服务端用于判断客户端是否在线。</span><br></pre></td></tr></table></figure>

<p><strong>Eureka 包含两个组件：Eureka Server 和 Eureka Client</strong></p>
<ul>
<li><strong>Eureka Server：</strong>Eureka 服务注册中心，主要用于提供服务注册功能。当微服务启动时，会将自己的服务注册到 Eureka Server。Eureka Server 维护了一个可用服务列表，存储了所有注册到 Eureka Server 的可用服务的信息，这些可用服务可以在 Eureka Server 的管理界面中直观看到。</li>
<li><strong>Eureka Client：</strong>Eureka 客户端，通常指的是微服务系统中各个微服务，主要用于和 Eureka Server 进行交互。在微服务应用启动后，Eureka Client 会向 Eureka Server 发送心跳（默认周期为 30 秒）。若 Eureka Server 在多个心跳周期内没有接收到某个 Eureka Client 的心跳，Eureka Server 将它从可用服务列表中移除（默认 90 秒）。 </li>
</ul>
<h3 id="2、-单机版Eureka构建"><a href="#2、-单机版Eureka构建" class="headerlink" title="2、 单机版Eureka构建"></a>2、 单机版Eureka构建</h3><p>按照图示一点一点构建整个项目</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830095125327.png" alt="image-20220830095125327"></p>
<h4 id="1-gt-IDEA生成-eurekaServer端服务中心"><a href="#1-gt-IDEA生成-eurekaServer端服务中心" class="headerlink" title="1&gt; IDEA生成 eurekaServer端服务中心"></a>1&gt; IDEA生成 eurekaServer端服务中心</h4><p>新建moudle工程，改pom，写yml，添加主启动类</p>
<p>eurekaServer端结构：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830094139380.png" alt="image-20220830094139380"></p>
<p>pom依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        eureka-server--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        web启动器--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        监控接口--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment"># eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># false表示不向注册中心注册自己（因为当前项目就是注册中心）</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索任务</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line">      <span class="comment"># 即 http://localhost:7001/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>

<p>主启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 标明到底是eureka的哪个组件</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaMain7001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaMain7001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>页面测试：<a target="_blank" rel="noopener" href="http://localhost:7001/">http://localhost:7001</a></p>
<p><img src="/2022/09/27/SpringCloud/image-20220830094539713.png" alt="image-20220830094539713"></p>
<h4 id="2-gt-payment8001注册进eurekaServer"><a href="#2-gt-payment8001注册进eurekaServer" class="headerlink" title="2&gt; payment8001注册进eurekaServer"></a>2&gt; payment8001注册进eurekaServer</h4><p>EurekaClient 端cloud-provider-payment8001将注册进 EurekaServer 成为服务提供者 provider，供8002使用</p>
<p>在8002的pom文件中引入新的jar包，eureka-client</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改yml文件，在原基础上添加 eureka 配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 表示是否将自己注册进EurekaServer默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>给主启动类加注释，标名为客户端</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830100617223.png" alt="image-20220830100617223"></p>
<p>启动测试：<font color="red">先启动 eureka-server</font></p>
<p><img src="/2022/09/27/SpringCloud/image-20220830100725735.png" alt="image-20220830100725735"></p>
<p>localhost:7001</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830100745261.png" alt="image-20220830100745261"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220830100840371.png" alt="image-20220830100840371"></p>
<h4 id="3-gt-consmer8002注册进eurekaServer"><a href="#3-gt-consmer8002注册进eurekaServer" class="headerlink" title="3&gt; consmer8002注册进eurekaServer"></a>3&gt; consmer8002注册进eurekaServer</h4><p>EurekaClient 端cloud-consmer-8002将注册进 EurekaServer 成为服务消费者 consumer，调用8001业务</p>
<p>跟上面一样，导 jar 包，改 yml，改启动类</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml:加个名字和配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>给主启动类加注释，@EnableEurekaClient</p>
<p>测试，先启动 EurekaServer7001，再启动服务提供者provider-8001；</p>
<p>localhost:7001</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830111230924.png" alt="image-20220830111230924"></p>
<p>爆红是Eurkea的自我保护机制</p>
<p>postman正常，哦耶</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830111309396.png" alt="image-20220830111309396"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不想入驻到 eurekaServer 就把yml属性改为false</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>





<h3 id="3、-集群Eureka构建"><a href="#3、-集群Eureka构建" class="headerlink" title="3、 集群Eureka构建"></a>3、 集群Eureka构建</h3><h4 id="1-gt-集群原理"><a href="#1-gt-集群原理" class="headerlink" title="1&gt; 集群原理"></a>1&gt; 集群原理</h4><p><img src="/2022/09/27/SpringCloud/image-20220830145141623.png" alt="image-20220830145141623"></p>
<p>  <img src="/2022/09/27/SpringCloud/image-20220830150807223.png" alt="image-20220830150807223"></p>
<p>如果是3个的话，就两两互相注册 （有个问题：那要几百个这么一个一个操作得累死，应该有什么便捷方法）</p>
<h4 id="2-gt-集群环境搭建"><a href="#2-gt-集群环境搭建" class="headerlink" title="2&gt; 集群环境搭建"></a>2&gt; 集群环境搭建</h4><p>新建一个 Eureka Server (moudle)</p>
<p>项目结构：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830155138463.png" alt="image-20220830155138463"></p>
<p>pom；和 cloud-eureka-server7001 相同；贴过来就行</p>
<p><strong>配置文件</strong>，需要改为集群式的配置文件  <font color="red">互相注册</font></p>
<p>​    本地的话，集群互相注册需要不同的主机名，所以本地想模拟需要修改 host 文件(因为都是localhost，只是端口不同)</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830155451222.png" alt="image-20220830155451222"></p>
<p>​    把需要的2个加进去</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830155911198.png" alt="image-20220830155911198"></p>
<p>7001的 application.yml</p>
<p>​    其他不变，defaultZone路径要变为要注册的新地址</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment"># eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># false表示不向注册中心注册自己（因为当前项目就是注册中心）</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索任务</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure>

<p>7002的 application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7002.com</span> <span class="comment"># eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># false表示不向注册中心注册自己（因为当前项目就是注册中心）</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索任务</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<p>localhost:7001 或 eureka7001.com:7001</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830161104155.png" alt="image-20220830161104155"></p>
<p>localhost:7002 或 eureka7002.com:7002</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830161247935.png" alt="image-20220830161247935"></p>
<h4 id="3-gt-把微服务注册到-Eureka-集群中"><a href="#3-gt-把微服务注册到-Eureka-集群中" class="headerlink" title="3&gt; 把微服务注册到 Eureka 集群中"></a>3&gt; 把微服务注册到 Eureka 集群中</h4><p>把 8001 和 8002 的 yml 配置修改即可，将注册的地址改为集群版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/  # 集群版</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220830162636677.png" alt="image-20220830162636677"></p>
<h4 id="4-gt-测试-01"><a href="#4-gt-测试-01" class="headerlink" title="4&gt; 测试-01"></a>4&gt; 测试-01</h4><p>先启动 eureka 集群 7001 和 7002；再启动 8001 ，然后 8002</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830163031671.png" alt="image-20220830163031671"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220830163044516.png" alt="image-20220830163044516"></p>
<p>postman 测试调用业务功能</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830163114476.png" alt="image-20220830163114476"></p>
<h4 id="5-gt-搭建服务端集群（支付者）"><a href="#5-gt-搭建服务端集群（支付者）" class="headerlink" title="5&gt; 搭建服务端集群（支付者）"></a>5&gt; 搭建服务端集群（支付者）</h4><p>新建 moudle   cloud-provider-payment8002  模拟多个服务端集群的效果</p>
<img src="/2022/09/27/SpringCloud/image-20220831132018155.png" alt="image-20220831132018155" style="zoom: 50%;">

<p>跟8001除了端口号其他完全一样，粘过来即可</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830194022234.png" alt="image-20220830194022234"></p>
<p>在controller中添加便于查看端口的</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830194412111.png" alt="image-20220830194412111"></p>
<p>把客户端端口号改一下，和服务端这个冲突了（我改成888了）</p>
<ol>
<li>修改服务端的 controller        服务端集群后，客户端调用服务时只需要关注名字；不用在乎到底调用的是哪一个端口</li>
</ol>
<p><img src="/2022/09/27/SpringCloud/image-20220830194952818.png" alt="image-20220830194952818"></p>
<ol start="2">
<li><p>修改后会出现错误；因为同名下有两个微服务，并不知道该调用哪个。</p>
</li>
<li><p>在 ApplicationContextConfig 使用 @LoadBalanced</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// 使 RestTemplate 具有负载均衡能力</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>测试：</p>
<p><font color="yellow">先启动EurekaServer     7001/7002</font></p>
<p><font color="yellow">再启动服务端     8001/8002</font></p>
<p><font color="yellow">客户端测试    888</font></p>
<p><img src="/2022/09/27/SpringCloud/image-20220830195245720.png" alt="image-20220830195245720"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220830195318203.png" alt="image-20220830195318203"></p>
<p>不停请求服务，8001和8002会相继出现，说明实现负载均衡</p>
<p>负载均衡默认是轮询机制，所以会依次调用不同服务端</p>
<p><img src="/2022/09/27/SpringCloud/image-20220830195542321.png" alt="image-20220830195542321"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220830195605928.png" alt="image-20220830195605928"></p>
<p>ApplicationContextBean      Ribbon的负载均衡功能</p>
<p>Ribbon和Eureka整合后Consumer可以直接调用服务而不用再关心地址和端口号，且服务还有负载均衡功能</p>
<h4 id="6-gt-actuator微服务信息完善"><a href="#6-gt-actuator微服务信息完善" class="headerlink" title="6&gt;  actuator微服务信息完善"></a>6&gt;  actuator微服务信息完善</h4><p>对整体并没有影响，但是一些细节的修改</p>
<ol>
<li>主机名称：服务名称修改</li>
</ol>
<p>​    问题：主机名称直接暴露在外</p>
<ol start="2">
<li>访问信息时，希望有IP显示</li>
</ol>
<p>​    找业务时，一般是，<strong>哪个IP，哪个端口，哪个微服务名称</strong></p>
<p>8001、8002的 yml 文件修改   eureka 下添加配置  8002对照着改相关信息即可</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">instance:</span></span><br><span class="line">	<span class="attr">instance-id:</span> <span class="string">payment8001</span>  <span class="comment"># 修改主机名</span></span><br><span class="line">	<span class="attr">prefer-ip-address:</span> <span class="literal">true</span>   <span class="comment"># 访问路径可以显示IP地址</span></span><br></pre></td></tr></table></figure>

<p>全部配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span>   <span class="comment"># 当前数据源操作类型</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span>    <span class="comment"># mysql驱动包</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/oldchen?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 表示是否将自己注册进EurekaServer默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:7001/eureka/  # 单机版</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span>  <span class="comment"># 集群版</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span>  <span class="comment"># 修改主机名</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>   <span class="comment"># 访问路径可以显示IP地址</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.atguigu.springcloud.entities</span>  <span class="comment"># 所有entity别名类所在包</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220831112138825.png" alt="image-20220831112138825"></p>
<p>注：服务端使用时，web 和 actuator 依赖一般绑定同时使用</p>
<p><img src="/2022/09/27/SpringCloud/image-20220831112437481.png" alt="image-20220831112437481"></p>
<p>actuator 的基本命令</p>
<p>​    监控端口是否正常运行</p>
<p><img src="/2022/09/27/SpringCloud/image-20220831112451743.png" alt="image-20220831112451743"></p>
<h4 id="7-gt-服务发现-discovery"><a href="#7-gt-服务发现-discovery" class="headerlink" title="7&gt;  服务发现 discovery"></a>7&gt;  服务发现 discovery</h4><p>用来让对方直观的看到有哪些微服务</p>
<p>8001端为例（8002相同的）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注： DiscoveryClient 是 org.springcloud 的 不是 netflix</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br></pre></td></tr></table></figure>

<p>添加新的 GetMapping</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看微服务信息</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/discovery&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">discovery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取在eureka中注册好的服务有哪些</span></span><br><span class="line">        List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">        <span class="keyword">for</span> (String element : services) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;*****element: &quot;</span> + element);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一个微服务下面的全部具体实例(某个名称下的)</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">            log.info(instance.getServiceId()+<span class="string">&quot;\t&quot;</span>+instance.getHost()+<span class="string">&quot;\t&quot;</span>+instance.getPort()+<span class="string">&quot;\t&quot;</span>+instance.getUri());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.discoveryClient;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>全部controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写操作 post</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/payment/create&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> Payment payment)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  int 是因为有 useGeneratedKeys 成功返回1，失败返回0</span></span><br><span class="line">        <span class="keyword">int</span> result = paymentService.create(payment);</span><br><span class="line">        log.info(<span class="string">&quot;***插入结果：&quot;</span>+result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span>  CommonResult(<span class="number">200</span>,<span class="string">&quot;插入成功,serverPort  &quot;</span>+serverPort,result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">444</span>,<span class="string">&quot;插入失败&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读操作 get</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        Payment payment = paymentService.getPaymentById(id);</span><br><span class="line">        log.info(<span class="string">&quot;***插入结果：&quot;</span>+payment);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (payment != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span>  CommonResult(<span class="number">200</span>,<span class="string">&quot;查询成功,serverPort  &quot;</span>+serverPort,payment);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">444</span>,<span class="string">&quot;没有对应记录,查询ID：&quot;</span>+id,<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看微服务信息</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/discovery&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">discovery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取在eureka中注册好的服务有哪些</span></span><br><span class="line">        List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">        <span class="keyword">for</span> (String element : services) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;*****element: &quot;</span> + element);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一个微服务下面的全部具体实例(某个名称下的)</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">            log.info(instance.getServiceId()+<span class="string">&quot;\t&quot;</span>+instance.getHost()+<span class="string">&quot;\t&quot;</span>+instance.getPort()+<span class="string">&quot;\t&quot;</span>+instance.getUri());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.discoveryClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>主启动类下添加 @EnableDiscoveryClient （以后会常用）</p>
<p><img src="/2022/09/27/SpringCloud/image-20220831135657289.png" alt="image-20220831135657289"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220831140310971.png" alt="image-20220831140310971"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220831140422862.png" alt="image-20220831140422862"></p>
<p>在 客户端 888 添加该接口后，以后可以直接知道有哪些服务；这样 服务端 也只对外展示一个整体的信息</p>
<h4 id="8-gt-Eureka-自我保护机制"><a href="#8-gt-Eureka-自我保护机制" class="headerlink" title="8&gt; Eureka 自我保护机制"></a>8&gt; Eureka 自我保护机制</h4><p>概述：保护模式主要用于一组客户端和Eureka Server 之间存在网络分区场景下的保护</p>
<p>进入保护模式后，Eureka Server 会尝试保护注册表中的内容，不再删除服务注册表中的内容，就是不会注销任何微服务</p>
<p>看到这段提示，既是进入保护模式</p>
<p><img src="/2022/09/27/SpringCloud/image-20220831141538329.png" alt="image-20220831141538329"></p>
<p><strong>一句话概括：某时刻某一微服务不能用了，Eureka 不会立刻清理，依旧会对该微服务的信息进行保存</strong></p>
<p><strong>属于CAP里面的AP分支</strong></p>
<p><font color="yellow">为什么会产生Eureka自我保护机制</font></p>
<p>​    防止当EurekaClient正常运行，但 EurekaServer 网络不通的情况下，EurekaServe不会立即将EurekaClient服务删除刷</p>
<p><font color="yellow">什么是自我保护模式</font></p>
<p>​    默认情况下，如果 EurekaServer 在一定时间内没有收到么某个微服务实例的心跳，EurekaServer 将会注销该实例（默认90秒）。但当网络分区发生故障（延时、卡顿、拥挤）时，微服务与 EurekaServer 之间无法正常通信，以上行为就变得很危险——–因为微服务本身是正常的，<font color="red">此时不应该被注销掉</font>。Eureka通过”自我保护模式”来解决这个问题——当EurekaServer 节点短时间丢失过多客户端时（可能发生网络分区故障），那么这个节点会进入自我保护模式</p>
<p>它的设计哲学是宁可保留错误的注册信息，也不盲目注销任何可能健康的服务实例    <font color="red">好死不如赖活</font></p>
<p>综上：自我保护是一种应对网络异常的保护措施</p>
<h4 id="9-gt-关闭自我保护机制"><a href="#9-gt-关闭自我保护机制" class="headerlink" title="9&gt;  关闭自我保护机制"></a>9&gt;  关闭自我保护机制</h4><p>7001端—–EurekaServer端</p>
<p>yml 修改配置    <strong>eureka.server.enable-self-preservation</strong>  默认为 true</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment"># eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># false表示不向注册中心注册自己（因为当前项目就是注册中心）</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索任务</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 集群只想其他 eureka</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span></span><br><span class="line">      <span class="comment"># 单机就是自己</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7001.com:7001/eureka/</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment"># 关闭自我保护机制，保证不可用服务被及时踢除</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 等待时间</span></span><br><span class="line">    <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>



<p>8001端—–EurekaClient端</p>
<p>修改 8001 yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Eureka 客户端向服务端发送心跳的时间间隔，单位为秒（默认30s）</span></span><br><span class="line"><span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># Eureka 服务端收到最后一次心跳后等待的时间上限，单位为秒（默认90s），超时将踢除服务</span></span><br><span class="line"><span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220831150808413.png" alt="image-20220831150808413"></p>
<h2 id="七、-Zookeeper注册与发现"><a href="#七、-Zookeeper注册与发现" class="headerlink" title="七、 Zookeeper注册与发现"></a>七、 Zookeeper注册与发现</h2><p>SpringCloud整合Zookeeper代替Eureka</p>
<p>机构和 Eureka 是完全相同的</p>
<h3 id="1-注册中心zookeeper"><a href="#1-注册中心zookeeper" class="headerlink" title="1.  注册中心zookeeper"></a>1.  注册中心zookeeper</h3><p>在虚拟机，centos上安装zookeeper；关闭防火墙</p>
<p>查下zookeeper的 ip 地址，保证可以和 win 系统进行 ping 通</p>
<h3 id="2-服务提供者"><a href="#2-服务提供者" class="headerlink" title="2. 服务提供者"></a>2. 服务提供者</h3><p>建新的 moudle  cloud-provider-payment8004</p>
<p> pom<img src="/2022/09/27/SpringCloud/image-20220902090547076.png" alt="image-20220902090547076"></p>
<p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloude-provider-payment</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="number">192.168</span><span class="number">.111</span><span class="number">.144</span><span class="string">:2181</span>  <span class="comment"># 一个zookeeper的地址，如果是集群，就直接逗号然后加</span></span><br></pre></td></tr></table></figure>

<p>main 函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>   <span class="comment">// 该注解用于向使用 consul 或 zookeeper 作为注册中心时注册服务</span></span><br></pre></td></tr></table></figure>

<p>controller     可以不带日志的注释，后头可能会报错</p>
<p><img src="/2022/09/27/SpringCloud/image-20220902092304620.png" alt="image-20220902092304620"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID.randomUUID().toString();   <span class="comment">// 随机生成的流水号</span></span><br></pre></td></tr></table></figure>

<p>启动zookeeper服务，再启动该微服务</p>
<p>启动会有bug出现，原因：8成是环境问题；maven 导入的 jar 包和虚拟机的 zookeeper 版本不一样</p>
<p><img src="/2022/09/27/SpringCloud/image-20220902093934658.png" alt="image-20220902093934658"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220902094214985.png" alt="image-20220902094214985"></p>
<p>​    zookeeper 作为注册中心，微服务是临时节点。当微服务停止发送心跳后，在一定的等待时间后，注册中心会把微服务踢掉</p>
<h3 id="3-服务消费者"><a href="#3-服务消费者" class="headerlink" title="3.  服务消费者"></a>3.  服务消费者</h3><p>和提供者差不多；跟Eureka逻辑都一样</p>
<h2 id="八、-Consul注册"><a href="#八、-Consul注册" class="headerlink" title="八、 Consul注册"></a>八、 Consul注册</h2><h3 id="1-Consul简介"><a href="#1-Consul简介" class="headerlink" title="1. Consul简介"></a>1. Consul简介</h3><p> Consul 是一套开源的分布式服务发现和配置管理系统，由Go语言开发</p>
<p>​    提供了微服务系统中的服务治理、配置中心、控制总线等功能。这些功能中的每一个都可以根据单独需要使用，也可以一起使用以构建全方位的服务网格。总之 Consul 是一套完整的服务网格解决方案</p>
<p>​    优点：基于 raft 协议，比较简介；支持健康检查，同时支持 HTTP 和 DNS 协议；支持跨数据中心的 WAN 集群；提供图形界面；跨平台。支持 Linux、Mac、Windows</p>
<p><strong>怎么用：</strong><a target="_blank" rel="noopener" href="https://www.springcloud.cc/spring-cloud-consul.html">Spring Cloud Consul 中文文档 参考手册 中文版</a></p>
<h3 id="2-Consul-下载和安装"><a href="#2-Consul-下载和安装" class="headerlink" title="2. Consul 下载和安装"></a>2. Consul 下载和安装</h3><p>官网下载，解压后直接就是一个exe文件</p>
<p>我把他放在 D 盘了<img src="/2022/09/27/SpringCloud/image-20220902155947402.png" alt="image-20220902155947402"></p>
<p>运行 cmd <img src="/2022/09/27/SpringCloud/image-20220902160017193.png" alt="image-20220902160017193"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220902160105554.png" alt="image-20220902160105554"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -dev        启动服务</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220902160215632.png" alt="image-20220902160215632"></p>
<p>localhost：8500    访问图形化界面</p>
<p><img src="/2022/09/27/SpringCloud/image-20220902160341024.png" alt="image-20220902160341024"></p>
<h3 id="3-服务提供者注册进consul"><a href="#3-服务提供者注册进consul" class="headerlink" title="3.  服务提供者注册进consul"></a>3.  服务提供者注册进consul</h3><p>熟悉的5步走</p>
<p>新的工程名：cloud-providerconsul-payment8006</p>
<p><img src="/2022/09/27/SpringCloud/image-20220905091222052.png" alt="image-20220905091222052"></p>
<p>pom 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        SpringCloud consul-server--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        web启动器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        监控接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-provider-payment</span></span><br><span class="line"><span class="comment">## consul 注册中心地址</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment"># hostname 127.0.0.1</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>

<p>主启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain8006</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8006.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接口用来测试微服务（用随机数生成流水号来测试）</span></span><br><span class="line">    <span class="comment">// RequestMapping包含各种请求头，可以指定</span></span><br><span class="line">    <span class="comment">// GetMapping  =》  RequestMapping(method=RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/payment/consul&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentConsul</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;springcloud with consul: &quot;</span> + serverPort + <span class="string">&quot;\t&quot;</span> + UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：  启动微服务和consul</p>
<img src="/2022/09/27/SpringCloud/image-20220905091747093.png" alt="image-20220905091747093" style="zoom:67%;">

<p>点进去可以看到它的安全状态</p>
<img src="/2022/09/27/SpringCloud/image-20220905091802113.png" alt="image-20220905091802113" style="zoom: 67%;">

<p><img src="/2022/09/27/SpringCloud/image-20220905091848320.png" alt="image-20220905091848320"></p>
<h3 id="4-服务消费者注册进consul"><a href="#4-服务消费者注册进consul" class="headerlink" title="4. 服务消费者注册进consul"></a>4. 服务消费者注册进consul</h3><p>建moudle、改pom、写yml、主启动、写config、业务层</p>
<p>cloud-consumerconsul-order889</p>
<img src="/2022/09/27/SpringCloud/image-20220905104006516.png" alt="image-20220905104006516" style="zoom:67%;">

<p>pom：(和服务提供者是一样的)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        SpringCloud consul-server--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        web启动器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        监控接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml：(就换了一个名字)</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">889</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-consumer-order</span></span><br><span class="line">  <span class="comment">## consul 注册中心地址</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment"># hostname 127.0.0.1</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>

<p>config：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span>  <span class="comment">// 使 RestTemplate 具有负载均衡能力</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderConsulController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INVOKE_URL = <span class="string">&quot;http://ApplicationContextConfig&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/consul/&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// RestTemplate 实现服务端向外网发送请求的场景 .get...即使用get方法请求</span></span><br><span class="line">        String result = restTemplate.getForObject(INVOKE_URL+<span class="string">&quot;/payment/consul&quot;</span>,String.class);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2022/09/27/SpringCloud/image-20220905104416423.png" alt="image-20220905104416423" style="zoom:67%;">

<img src="/2022/09/27/SpringCloud/image-20220905104724771.png" alt="image-20220905104724771" style="zoom:67%;">



<h2 id="九、-三种注册中心的异同点"><a href="#九、-三种注册中心的异同点" class="headerlink" title="九、 三种注册中心的异同点"></a>九、 三种注册中心的异同点</h2><table>
<thead>
<tr>
<th><strong>组件名</strong></th>
<th><strong>语言</strong></th>
<th><strong>CAP</strong></th>
<th><strong>服务健康检查</strong></th>
<th><strong>对外暴露接口</strong></th>
<th><strong>SpringCloud集成</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>Java</td>
<td>AP</td>
<td>可配支持</td>
<td>HTTP</td>
<td>已集成</td>
</tr>
<tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
<td>支持</td>
<td>HTTP/DNS</td>
<td>已集成</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
<td>支持</td>
<td>客户端</td>
<td>已集成</td>
</tr>
</tbody></table>
<p>A：高可用</p>
<p>C：数据一致</p>
<p>P：分区容错性</p>
<p>CAP理论：关注粒度是数据，而不是整体系统设计的策略</p>
<p><font color="yellow">最多只能较好的满足两个</font>(实际情况好像要看网络情况来判断)</p>
<p>CA：单点集群，满足一致性，高可用系统，可扩展性上不太强大</p>
<p>CP：满足一致性，分区容灾性的系统，一般性能不是太高</p>
<p>AP：满足一致性，分区容灾性的系统，对一致性要求比较低</p>
<h2 id="十、Ribbon负载均衡服务调用"><a href="#十、Ribbon负载均衡服务调用" class="headerlink" title="十、Ribbon负载均衡服务调用"></a>十、Ribbon负载均衡服务调用</h2><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h3><p>Ribbon是一套<font color="yellow">客户端</font>，实现负载均衡的工具</p>
<p>​    主要功能是提供负载均衡算法和服务调用；Ribbon会自动帮助你基于某种规则（简单的轮询或随机连接等）连接机器。也可以使用Ribbon实现自定义的负载均衡算法</p>
<p>​    Ribbon目前进入维护状态，但依然大规模部署（目前依然主流和成熟） 未来–&gt; springcloud loadbalancer</p>
<p><strong>LB（负载均衡）：</strong>   集中式LB和进程内LB</p>
<p><font color="yellow">LB负载均衡（Load Balance）是什么</font></p>
<p>​    是将用户请求平摊分到多个服务响应端，来实现系统高可用的目的（HV）</p>
<p>​    常见的负载均衡软件有：Nginx、LVS（Linux虚拟服务器）、硬件F5等</p>
<p><font color="yellow">Ribbon本地负载均衡客户端 VS Nginx服务端负载均衡区别</font></p>
<p>​    Nginx是服务器负载均衡（集中式LB），客户端所有的请求都发送给Nginx；然后由Nginx实现转发请求。即负载均衡由服务器实现</p>
<p>​    Ribbon本地负载均衡（进程内LB），在调用微服务接口时，会在注册中心获取服务列表并缓存到JVM本地；在本地实现RPC远程调用技术</p>
<p><font color="yellow">集中式LB：</font>在服务的消费方和提供方之间使用的独立的LB设施（硬件如：F5；软件如：Nginx）。该设施通过某种策略把请求转发到服务提供方（类似于一个医院，进去之后，去哪由医院来分配）</p>
<p><font color="yellow">进程式LB：</font>将LB逻辑集成到消费方，消费方从注册中心得知哪些地址可用，自己挑选一个可用服务器（类似于一个科室，大夫是现成的，进去自己挑）</p>
<p>​    Ribbon属于进程内LB，它只是一个类库，集成于消费方进程，消费方通过它获取服务提供方地址</p>
<p>Ribbon：负载均衡 + RestTemplate调用</p>
<h3 id="2-怎么用"><a href="#2-怎么用" class="headerlink" title="2. 怎么用"></a>2. 怎么用</h3><p>架构：Ribbon是一个软负载均衡客户端组件（软负载均衡即软件负载均衡）</p>
<p>可以和其他所需请求客户端结合使用，和eureka结合只是一个实例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入该依赖时，会自带ribbon--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220906165435093.png" alt="image-20220906165435093"></p>
<h4 id="RestTemplate的使用"><a href="#RestTemplate的使用" class="headerlink" title="RestTemplate的使用"></a>RestTemplate的使用</h4><p>常用：    getForObject/getForEntity      postForObject/postForEntity</p>
<p>Object：返回对象为响应体中数据转换的对象，基本上可以理解为json</p>
<p>Entity：返回对象为ResponseEntity对象，包含了响应中的一些重要信息；响应头、响应状态码、响应体（想知道详细信息就用entity，调用get方法可获得详细的信息）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"><span class="comment">//    public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;; // 单机版（写死了）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 变为集群时，不关注某一端口，只通过hostname去寻找</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PAYMENT_URL = <span class="string">&quot;http://CLOUD-PAYMENT-SERVICE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/create&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">create</span><span class="params">(Payment payment)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Object 和 Entity 方法</span></span><br><span class="line">        <span class="comment">//return restTemplate.postForObject(PAYMENT_URL + &quot;/payment/create&quot;,payment,CommonResult.class);</span></span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForEntity(PAYMENT_URL + <span class="string">&quot;/payment/create&quot;</span>,payment,CommonResult.class).getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(PAYMENT_URL+<span class="string">&quot;/payment/get/&quot;</span>+id,CommonResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/getEntity/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPayment2</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        ResponseEntity&lt;CommonResult&gt; entity = restTemplate.getForEntity(PAYMENT_URL+<span class="string">&quot;/payment/get/&quot;</span>+id,CommonResult.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (entity.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">            <span class="keyword">return</span> entity.getBody();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;操作失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果，两者是一样的；只是Entity可以返回单个详细的部分</p>
<img src="/2022/09/27/SpringCloud/image-20220906190830406.png" alt="image-20220906190830406" style="zoom: 80%;">

<h3 id="3-Ribbon-默认的负载规则"><a href="#3-Ribbon-默认的负载规则" class="headerlink" title="3. Ribbon 默认的负载规则"></a>3. Ribbon 默认的负载规则</h3><p><strong>默认规则是：轮询</strong></p>
<p>IRule接口：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220906191202261.png" alt="image-20220906191202261"></p>
<p>该接口的实现类：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220906191906784.png" alt="image-20220906191906784"></p>
<img src="/2022/09/27/SpringCloud/image-20220906191630967.png" alt="image-20220906191630967" style="zoom:80%;">

<p>自带的常见的用法：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220906191716372.png" alt="image-20220906191716372"></p>
<h3 id="4-替换Ribbon的规则"><a href="#4-替换Ribbon的规则" class="headerlink" title="4. 替换Ribbon的规则"></a>4. 替换Ribbon的规则</h3><p><strong>这个自定义配置类不能放在@ComponentScan所扫描的子包下面，否则达不到特殊化的目的</strong></p>
<p>​    即 @SpringBootApplication 注释中带有的 @ComponentScan 会扫描本包下的所有配置；本例中就是在com.atguigu.springcloud 之外建包</p>
<p><img src="/2022/09/27/SpringCloud/image-20220906192926893.png" alt="image-20220906192926893"></p>
<p>换一种替换规则需要自己指定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySelfRule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">myRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule(); <span class="comment">// 定义为随机</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在主启动中配置，当启动时，Ribbon执行自定义的规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// name：找这个服务名的服务；  configuration是使用该配置类</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;, configuration = MySelfRule.class)</span></span><br></pre></td></tr></table></figure>

<img src="/2022/09/27/SpringCloud/image-20220906194520853.png" alt="image-20220906194520853" style="zoom:80%;">

<h3 id="5-轮询规则的原理"><a href="#5-轮询规则的原理" class="headerlink" title="5. 轮询规则的原理"></a>5. 轮询规则的原理</h3><p>负载均衡算法： rest接口第几次发起请求 % 服务器集群总数 = 实际调用服务器的位置下标</p>
<p><strong>当服务重启时，计数从1算起</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">如：List[<span class="number">0</span>] instances = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8002</span></span><br><span class="line">    List[<span class="number">1</span>] instances= <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8001</span></span><br><span class="line"><span class="number">8002</span> 和 <span class="number">8001</span> 组成集群，按照轮询的算法：</span><br><span class="line">    <span class="number">1</span> % <span class="number">2</span> = <span class="number">1</span>  --》 index = <span class="number">1</span>  list.get(index); 获得服务地址就是 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8001</span></span><br><span class="line">    <span class="number">2</span> % <span class="number">2</span> = <span class="number">0</span>  --》 index = <span class="number">0</span>  list.get(index); 获得服务地址就是 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8002</span></span><br><span class="line">    <span class="number">3</span> % <span class="number">2</span> = <span class="number">1</span>  --》 index = <span class="number">1</span>  list.get(index); 获得服务地址就是 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8001</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>



<p>源码-查看：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220906202010221.png" alt="image-20220906202010221"></p>
<h3 id="6-手写轮询算法"><a href="#6-手写轮询算法" class="headerlink" title="6. 手写轮询算法"></a>6. 手写轮询算法</h3><p>启动7001，7002 eureka 集群</p>
<p>给8001，8002 添加一个测试接口；启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/lb&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPaymentLB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serverPort;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p><strong>888 消费者改造</strong></p>
<ol>
<li>把 ApplicationContextConfig 里的 @LoadBalanced 注释掉；(因为接下来使用自己写的轮询规则)</li>
<li>新建接口类，以及实现类</li>
</ol>
<img src="/2022/09/27/SpringCloud/image-20220907153019499.png" alt="image-20220907153019499" style="zoom:80%;">

<p>接口类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoadBalancer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 得到机器的列表（有哪些微服务可以提供）</span></span><br><span class="line">    <span class="function">ServiceInstance <span class="title">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现类</p>
<p>源码中也使用了自旋锁，例如：for( ; ; )   内部有自己跳出循环的条件</p>
<p>​    这里自定义的方法使用 do-while 实现自旋锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLB</span> <span class="keyword">implements</span> <span class="title">LoadBalancer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提供一个原子类，初始值为0</span></span><br><span class="line">    <span class="comment">// 原子类可在高并发场景下高效处理程序；并保证线程安全(Java语言中，++i和i++操作并不是线程安全的)</span></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到并增加</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> current;</span><br><span class="line">        <span class="keyword">int</span> next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            current = <span class="keyword">this</span>.atomicInteger.get();</span><br><span class="line">            next = current &gt;= <span class="number">2147483647</span> ? <span class="number">0</span> : current + <span class="number">1</span>; <span class="comment">// 2147483647:int的最大值</span></span><br><span class="line">        &#125;<span class="keyword">while</span> (!<span class="keyword">this</span>.atomicInteger.compareAndSet(current,next)); <span class="comment">// 自旋，一直取到想要的值为之</span></span><br><span class="line">        System.out.println(<span class="string">&quot;******第几次访问，next： &quot;</span>+next);</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServiceInstance <span class="title">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// getAndIncrement 代表第几次访问</span></span><br><span class="line">        <span class="keyword">int</span> index = getAndIncrement() % serviceInstances.size();</span><br><span class="line">        <span class="keyword">return</span> serviceInstances.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>OrderController 新增接口</li>
</ol>
<p>@Resource 和 @Autowired</p>
<p>​    @Autowired:属于Spring，按类型匹配，byType</p>
<p>​        <font color="red">缺点：</font>当实现类有两个以上时，容易有冲突；要使用它注入要确保只有一个实现类</p>
<p>​    @Resource：属于J2EE，按名称匹配，byName。更准确一些，减少了与spring的耦合。查名字的速度也要更快</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> LoadBalancer loadBalancer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/lb&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPaymentLB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过名字得到的 List，就是 LoadBalancer 接口中需要的List</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (instances == <span class="keyword">null</span> || instances.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ServiceInstance serviceInstance = loadBalancer.instances(instances);</span><br><span class="line">    URI uri = serviceInstance.getUri();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(uri+<span class="string">&quot;/payment/lb&quot;</span>,String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<img src="/2022/09/27/SpringCloud/image-20220907153454719.png" alt="image-20220907153454719" style="zoom:80%;">



<h2 id="十一、OpenFeign的服务调用"><a href="#十一、OpenFeign的服务调用" class="headerlink" title="十一、OpenFeign的服务调用"></a>十一、OpenFeign的服务调用</h2><p>用在客户端，使用方法是<font color="yellow">定义一个服务接口，然后在上面添加注解。</font></p>
<p>Feign可以和Eureka和Ribbon组合使用来实现负载均衡</p>
<p><font color="yellow">Feign干什么：</font>（服务接口绑定器）</p>
<p>​    旨在使编写Java Http客户端变得容易，实际情况中，一个接口会被多次调用，所以需要对每个微服务都封装一些客户端调用。在Feign的实现下，我们只需要创建一些接口，使用接口调接口的方式，实现服务方的接口绑定</p>
<p>​    看微服务的service中使用了哪些服务，那客户端就创建对应的接口</p>
<p>​    通过Feign，只需要定义服务绑定接口并声明方法，就可实现服务调用</p>
<p>Feign已经被OpenFeign代替</p>
<h3 id="1-使用步骤"><a href="#1-使用步骤" class="headerlink" title="1. 使用步骤"></a>1. 使用步骤</h3><p>建新的工程 cloud-consumer-feign-order890</p>
<img src="/2022/09/27/SpringCloud/image-20220910104355945.png" alt="image-20220910104355945" style="zoom:80%;">

<p>OpenFeign对Ribbon进行了集成，依赖中包含负载均衡内容</p>
<img src="/2022/09/27/SpringCloud/image-20220910104913398.png" alt="image-20220910104913398" style="zoom:80%;">

<p>OpenFeign是Spring官方推出的一种声明式服务调用与负载均衡组件</p>
<p><font color="yellow"><strong>核心：微服务调用接口 + @FeignClient</strong></font></p>
<p>pom.xml  新内容只多了一个<strong>openfeign</strong>的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        web启动器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        监控接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">890</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line"><span class="comment">#    因为当前是消费者，所以不需要注册进注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span>  <span class="comment"># 集群版</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">主启动：  @EnableFeignClients    (激活)</span><br><span class="line">业务类：  @FeignClient           (启动)</span><br></pre></td></tr></table></figure>

<p>主启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 使用 Feign 激活并开启</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFeignMain890</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderFeignMain890.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>业务类：</p>
<p>Service：使用8001暴露的接口，有什么就调什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加为容器内的一个组件</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// 实现负载均衡和服务调用-----value：服务提供者提供的服务名称</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentFeignService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">CommonResult&lt;Payment&gt; <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFeignController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>先启动7001、7002；在启动8001、8002</p>
<p>启动890测试，服务调用能力和负载均衡功能都正常</p>
<img src="/2022/09/27/SpringCloud/image-20220910105142422.png" alt="image-20220910105142422" style="zoom: 67%;">

<p>总结：面向接口编程</p>
<p><img src="/2022/09/27/SpringCloud/image-20220910105758746.png" alt="image-20220910105758746"></p>
<h3 id="2-OpenFeign-超时控制"><a href="#2-OpenFeign-超时控制" class="headerlink" title="2. OpenFeign 超时控制"></a>2. OpenFeign 超时控制</h3><p>​    会出现一种情况，消费者需要调用服务提供者服务；服务方完成这次服务需要 3s，但消费者只能等待 2s；那超时的话，消费者方就会直接报错</p>
<p>OpenFeign 客户端默认等待 1s</p>
<p>1&gt; 服务提供方8001故意写一个暂停程序接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/feign/timeout&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentFeignTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 程序进来后停3s后返回</span></span><br><span class="line">    <span class="comment">// 暂停几秒钟线程,模拟假如服务提供端的是一个长业务需要一段时间处理</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serverPort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2&gt; 80 添加超时方法</p>
<p>service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@GetMapping(&quot;/payment/feign/timeout&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">paymentFeignTimeout</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>controller:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/feign/timeout&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentFeignTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// openfeign 底层 ribbon；默认等待 1s</span></span><br><span class="line">    <span class="keyword">return</span> paymentFeignService.paymentFeignTimeout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3&gt;  错误页面</p>
<img src="/2022/09/27/SpringCloud/image-20220910212843581.png" alt="image-20220910212843581" style="zoom:67%;">

<p>4&gt; yml中开启配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 feign 客户端超时时间(OpenFile默认支持ribbon)</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment">#处理请求的超时时间，默认为5秒</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment">#连接建立的超时时长，默认5秒</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<img src="/2022/09/27/SpringCloud/image-20220910213033768.png" alt="image-20220910213033768" style="zoom:80%;">

<h3 id="3-OpenFeign-日志打印功能"><a href="#3-OpenFeign-日志打印功能" class="headerlink" title="3. OpenFeign 日志打印功能"></a>3. OpenFeign 日志打印功能</h3><p>我们可以通过调整日志级别，从而了解 Feign 中的 Http 请求细节。</p>
<p><font color="yellow">对Feign接口的调用情况进行监控和输出</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">日志级别：</span><br><span class="line">NONE: 默认的，不显示日志</span><br><span class="line">BASIC：仅记录请求方法、URL、响应状态码和执行时间</span><br><span class="line">HEADERS：除了 BASIC 中定义的信息外，还有请求和响应的头信息</span><br><span class="line">FULL：除了 HEADERS 中定义的信息外，还有请求响应的正文和元数据</span><br></pre></td></tr></table></figure>

<p>config类：<br><img src="/2022/09/27/SpringCloud/image-20220910214538911.png" alt="image-20220910214538911"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># feign 日志以什么级别监控哪个接口 （监控service的服务接口）</span></span><br><span class="line">    <span class="attr">com.atguigu.springcloud.Service.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>测试：调用某一接口后，查看打印的日志信息</p>
<p><img src="/2022/09/27/SpringCloud/image-20220910214907841.png" alt="image-20220910214907841"></p>
<h2 id="十二、-Hystrix-服务熔断器"><a href="#十二、-Hystrix-服务熔断器" class="headerlink" title="十二、 Hystrix 服务熔断器"></a>十二、 Hystrix 服务熔断器</h2><p>分布式系统面临的问题：</p>
<p>​    复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候不可避免的的会失败</p>
<p>​    服务雪崩：多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他微服务，这就是所谓的<strong>“扇出”</strong>。如果扇出的链路上某个微服务的调用响应时间过长或不可用，对微服务A就会占用更多资源，进而引起系统崩溃，所谓<strong>“雪崩效应”</strong></p>
<p>​    对于高流量的应用来说，单一的后端依赖可能导致所有服务器上的所有资源在几秒内饱和。</p>
<p>​    <strong>Hystrix</strong>是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统中，许多依赖不可避免的会出现调用失败，比如超时、异常。Hystrix能够保证在一个依赖出现问题的情况下，不会导致整体服务失败，避免级联故障</p>
<p>​    “断路器”是一种开关，当某个单元发生故障后，向调用方返回一个符合预期的、可处理的备选响应(FallBack)，而不是长时间等待或抛出调用方无法处理的异常。</p>
<p><strong>Hystrix的主要功能：</strong>服务降级、服务熔断、接近实时的监控…</p>
<p><font color="yellow">官方宣布，停更进行维护</font></p>
<h3 id="1-Hystrix重要概念"><a href="#1-Hystrix重要概念" class="headerlink" title="1. Hystrix重要概念"></a>1. Hystrix重要概念</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fallback--服务降级；服务器忙，请稍后再试；不让客户端等待，并返回一个友好提示</span><br><span class="line">	哪些情况后触发降级：1.程序运行异常 2.超时  3.服务熔断触发服务降级  4.线程池/信号量打满也会导致服务降级</span><br><span class="line">	</span><br><span class="line">break--服务熔断；类比保险丝，当达到最大访问服务时，直接拒绝访问，拉闸限电，并调用服务降级返回友好提示</span><br><span class="line">	服务降级-&gt;熔断-&gt;恢复链路</span><br><span class="line">	</span><br><span class="line">flowlimit--秒杀高并发等操作，严禁一窝蜂的拥挤，大家排队，一秒几个</span><br></pre></td></tr></table></figure>



<h3 id="2-构建"><a href="#2-构建" class="headerlink" title="2. 构建"></a>2. 构建</h3><p>先把 Eureka7001改回单机版，方便调试</p>
<p>新工程：cloud-provider-hystrix-payment8001</p>
<img src="/2022/09/27/SpringCloud/image-20220911094344427.png" alt="image-20220911094344427" style="zoom:80%;">

<p>pom：引入hystrix的jar包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--hystrix--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        web启动器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        监控接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-hystrix-payment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 没开集群</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 注册进 eureka</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentHystrixMain8001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentHystrixMain8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service和controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">应该是建一个接口类，在再impl实现的，这里为了省事</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正常访问，一切ok</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_OK</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：  &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;  payment_OK,id:  &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;hhhhh&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟超时;假装它是个复杂的业务流程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_Timeout</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 暂停几秒，为了触发服务降级</span></span><br><span class="line">        <span class="keyword">int</span> timeNumber = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：  &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;  payment_Timeout,id:  &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;错了错了,耗时：&quot;</span>+timeNumber;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        String result = paymentService.payment_OK(id);</span><br><span class="line">        log.info(<span class="string">&quot;****result: &quot;</span>+result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        String result = paymentService.payment_Timeout(id);</span><br><span class="line">        log.info(<span class="string">&quot;****result: &quot;</span>+result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：启动7001，再8001；两个接口均正常，timeout会延迟3s后返回；模拟一个复杂进程需要的处理时间</p>
<img src="/2022/09/27/SpringCloud/image-20220911094813062.png" alt="image-20220911094813062" style="zoom:67%;">

<img src="/2022/09/27/SpringCloud/image-20220911094755040.png" alt="image-20220911094755040" style="zoom:67%;">

<p><font color="yellow">以上述Moudle为根基平台，正确-&gt;错误-&gt;降级熔断-&gt;恢复</font></p>
<h3 id="3-高并发测试"><a href="#3-高并发测试" class="headerlink" title="3. 高并发测试"></a>3. 高并发测试</h3><p>​    Jmeter工具–性能测试，20000个线程同时运行，去访问接口，会出现卡顿现象；因为tomcat默认的工作线程数被打满了，没有多余的线程缓解压力和处理（tomcat最大活跃线程数200）</p>
<p>​    结论：这还只是服务提供者8001自己测试，假如外部消费者也来调用服务，那消费者只能干等，最终导致消费端不满意，服务端被拖死</p>
<h3 id="4-新建消费端加入"><a href="#4-新建消费端加入" class="headerlink" title="4. 新建消费端加入"></a>4. 新建消费端加入</h3><p><strong>hystrix一般用在消费端做降级</strong>（服务端也能用）</p>
<p>建新的消费端：cloud-consumer-feign-hystrix-order891</p>
<img src="/2022/09/27/SpringCloud/image-20220911111517704.png" alt="image-20220911111517704" style="zoom:80%;">

<p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--hystrix--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        web启动器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        监控接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: <span class="number">891</span></span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    register-with-eureka: <span class="keyword">false</span></span><br><span class="line">    service-url:</span><br><span class="line">      # 没开集群</span><br><span class="line">      defaultZone: http:<span class="comment">//eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>主启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 激活feign</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderHystrixMain891</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderHystrixMain891.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">// 把该类注入进spring容器中（注入bean）</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;)</span> <span class="comment">// 服务提供方8001</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentHystrixService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderHystrixController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentHystrixService paymentHystrixService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.payment_OK(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.payment_Timeout(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<img src="/2022/09/27/SpringCloud/image-20220911111900321.png" alt="image-20220911111900321" style="zoom:80%;">

<p><font color="red">但是</font>用Jmeter将2W个线程压8001，消费端891要么转圈圈等待，要么返回超时报错</p>
<p>故障现象和导致原因：</p>
<p>​    8001同一层次的其他接口被困死，因为tomcat线程池里的工作线程已经被挤占，如果891再去访问8001就，客户端就容易出现卡顿。<strong>所以出现了降级、容错、限流等技术的诞生</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">解决问题：</span><br><span class="line">超时导致服务器变慢（转圈）----超时不再等待</span><br><span class="line">出错（宕机或程序运行出错）----出错要有兜底，有一个最终显示</span><br><span class="line"></span><br><span class="line">服务（8001）超时或者宕机了，调用者不能卡死一直等待，必须有服务降级</span><br><span class="line">服务（8001）业务ok，但是调用者自己出现故障或有自我要求（自己等待的时间小于服务提供者），自己处理j</span><br></pre></td></tr></table></figure>



<h3 id="5-服务降级"><a href="#5-服务降级" class="headerlink" title="5. 服务降级"></a>5. 服务降级</h3><p><font color="yellow">服务降级一般在消费端</font></p>
<h4 id="8001-fallback"><a href="#8001-fallback" class="headerlink" title="8001 fallback"></a>8001 fallback</h4><p>修改8001：设置自身调用超时时间的峰值，峰值内可以正常运行，超过了需要有兜底的方法处理，做降级处理fallback</p>
<p>业务类启用：<font color="yellow">@HystrixCommand</font></p>
<p>主启动类激活：<font color="yellow">@EnableCircuitBreaker</font></p>
<p>当前服务不可用了，就做服务降级</p>
<p>修改8001的 PaymentService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务降级注解</span></span><br><span class="line"><span class="comment">// 调用方法的峰值是3s，3s以内就是正常的业务逻辑payment_Timeout；超过3s了就报错，执行兜底的业务逻辑 fallback制定的类： payment_TimeoutHandler</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;payment_TimeoutHandler&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">payment_Timeout</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 暂停几秒，为了触发服务降级</span></span><br><span class="line">    <span class="keyword">int</span> timeNumber = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;线程池：  &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;  payment_Timeout,id:  &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;哈哈^_^,耗时：&quot;</span>+timeNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// payment_Timeout 服务出现问题后，找该方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">payment_TimeoutHandler</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;线程池：  &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;  系统繁忙，请稍后再试,id:  &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;oT_To&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>8001主启动类添加注解：@EnableCircuitBreaker</p>
<p><img src="/2022/09/27/SpringCloud/image-20220913093731894.png" alt="image-20220913093731894"></p>
<p>测试：设置程序运行峰值为3s，但程序需要5s，应该返回兜底逻辑部分</p>
<p><img src="/2022/09/27/SpringCloud/image-20220913094043989.png" alt="image-20220913094043989"></p>
<img src="/2022/09/27/SpringCloud/image-20220913094720084.png" alt="image-20220913094720084" style="zoom:67%;">

<h4 id="890-fallback"><a href="#890-fallback" class="headerlink" title="890 fallback"></a>890 fallback</h4><p>yml：添加配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>主启动类添加注解：@EnableHystrix</p>
<p>修改890 controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentTimeoutFallbackMethod&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;1500&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">payment_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> paymentHystrixService.payment_Timeout(id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentTimeoutFallbackMethod</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;我是消费者80，对方支付系统繁忙，请10秒钟后再试或者检查自己运行程序，oT_To&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="yellow">修改Hystrix属性的话，建议重启，而不是热部署</font></p>
<p>测试：服务端最多等待3s，但是消费端最多只能等待1.5s，所以消费端直接 fallback</p>
<p><img src="/2022/09/27/SpringCloud/image-20220913101004935.png" alt="image-20220913101004935"></p>
<h4 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h4><ol>
<li><strong>每个业务方法都对应一个兜底方法，导致代码膨胀</strong></li>
</ol>
<p>统一和自定义的方法分开</p>
<p>解决办法：设置一个全局服务降级配置</p>
<img src="/2022/09/27/SpringCloud/image-20220913102718120.png" alt="image-20220913102718120">

<p>测试：服务降级会走全局配置</p>
<p><img src="/2022/09/27/SpringCloud/image-20220913102823561.png" alt="image-20220913102823561"></p>
<ol start="2">
<li><strong>降级和业务逻辑混合在一起，耦合性太高，混乱</strong></li>
</ol>
<p>每个降级处理的业务逻辑都和主要业务混合在一块，非常混乱</p>
<p>服务降级，客户端去调用服务端，碰上服务端宕机或关闭</p>
<p>​    该案例服务降级处理是<font color="yellow">在客户端实现</font>，与服务端没有关系，只需要为Feign客户端定义的接口添加一个服务降级处理的实现类即可时间解耦</p>
<p><strong>未来我们要面对的异常：运行、超时、宕机</strong></p>
<p>所有的服务是从PaymentHystrixService接口中调用，新建一个类实现该接口并做服务降级</p>
<p><img src="/2022/09/27/SpringCloud/image-20220913135545890.png" alt="image-20220913135545890"></p>
<p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组件的注解，否则springboot容器扫描不到</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title">PaymentHystrixService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_OK</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-----PaymentFallbackService fall back-payment_OK,  ·T_T·&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payment_Timeout</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-----PaymentFallbackService fall back-payment_Timeout, ·T_T·&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220913135707530.png" alt="image-20220913135707530"></p>
<p>测试：启动7001，8001，891</p>
<p>正常调用：<img src="/2022/09/27/SpringCloud/image-20220913140036839.png" alt="image-20220913140036839"></p>
<p>关闭8001模仿宕机：<img src="/2022/09/27/SpringCloud/image-20220913135850157.png" alt="image-20220913135850157"></p>
<p>此时服务端已经宕机，但我们做了降级处理，让客户端在服务端不可用也会获得提示，不会挂起耗死服务器</p>
<h3 id="6-服务熔断"><a href="#6-服务熔断" class="headerlink" title="6. 服务熔断"></a>6. 服务熔断</h3><p>类似保险丝</p>
<p><strong>论文：</strong><a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">CircuitBreaker (martinfowler.com)</a></p>
<p>熔断机制概述：</p>
<p>​    熔断机制是应对雪崩效应的一种微服务链路保护机制。当某个微服务不可用或响应时间过长时，会进行服务降级，进而熔断该节点的微服务调用，快速返回错误的响应信息。<font color="yellow">当检测到该节点的微服务调用响应正常后，恢复调用链路</font>(一种特殊的服务降级吧)</p>
<p>​    SpringCloud框架中，熔断机制通过Hystrix实现。当失败的调用到一定阈值时，缺省是5秒内20次调用失败，就会启动熔断机制。注解是 @HystrixCommand</p>
<p>修改8001 PaymentService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ======服务熔断</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;), //是否开启断路器</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;), //请求次数</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;), //时间窗口期</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;), //失败率达到多少跳闸</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 故意传一个id为负数，作为运行时异常</span></span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;******id 不能为负数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// hutool工具类的生成唯一识别码的工具</span></span><br><span class="line">    String serialNumber = IdUtil.simpleUUID(); <span class="comment">// 等同于 UUID.randomUUID().toString()</span></span><br><span class="line">    <span class="keyword">return</span> Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;调用成功，流水号： &quot;</span> + serialNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker_fallback</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;id 不能负数，请稍后再试，/(ToT)/~~   id: &quot;</span>+id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ======服务熔断</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payment/circuit/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>&#123;</span><br><span class="line">    String result = paymentService.paymentCircuitBreaker(id);</span><br><span class="line">    log.info(<span class="string">&quot;*****result:&quot;</span> + result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>id为正数：<img src="/2022/09/27/SpringCloud/image-20220913151240191.png" alt="image-20220913151240191" style="zoom:80%;"></p>
<p>id为负数：<img src="/2022/09/27/SpringCloud/image-20220913151302799.png" alt="image-20220913151302799"></p>
<p>多次提交负数后，达到熔断的条件<img src="/2022/09/27/SpringCloud/image-20220913151506352.png" alt="image-20220913151506352"></p>
<p>再当id为正数时，返回依旧是服务降级页面，链路还未恢复：<img src="/2022/09/27/SpringCloud/image-20220913151626374.png" alt="image-20220913151626374"></p>
<p>等一会链路就会自动恢复：<img src="/2022/09/27/SpringCloud/image-20220913151649816.png" alt="image-20220913151649816"></p>
<p>总结：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220913153223459.png" alt="image-20220913153223459"></p>
<p>​    <font color="yellow">熔断类型：</font></p>
<ol>
<li>熔断打开：请求不再进行调用当前服务，内部设置时钟一般为MTTR(平均故障处理时间)，当打开时长达到所设时钟则进入半熔断状态</li>
<li>熔断关闭：熔断关闭不会对服务进行熔断</li>
<li>熔断半开：部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断</li>
</ol>
<p>​    <font color="yellow">断路器开启或关闭的条件：</font></p>
<ol>
<li>当满足一定的阀值时（默认是10s 内超过20个请求次数）</li>
<li>当失败率达到一定的时候（默认10s 内超过50%的请求失败）</li>
<li>当到达以上阀值，断路器将会开启</li>
<li>当开启的时候，所有请求都不会转发</li>
<li>一段时间后（默认是5s），这时断路器是半开状态，会让其中一个请求进行转发。(探子)如果成功，断路器会关闭，若失败，继续开启。重复4和5</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">断路器打开后，再有请求调用时，将不会调用主逻辑，而是直接调用降级fallback。通过断路器，实现自动地发现错误并将降级逻辑切换为主逻辑，减少应用响应时间</span><br></pre></td></tr></table></figure>



<h3 id="7-Hystrix-Dashboard"><a href="#7-Hystrix-Dashboard" class="headerlink" title="7. Hystrix Dashboard"></a>7. Hystrix Dashboard</h3><p><strong>图形化监控</strong></p>
<p>新建监控平台 moudle：cloud-consumer-hystrix-dashboard9001</p>
<p>pom依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml：只用配置一个9001端口</p>
<p>主启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixDashboardMain9001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HystrixDashboardMain9001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问：<a target="_blank" rel="noopener" href="http://localhost:9001/hystrix">http://localhost:9001/hystrix</a></p>
<p><img src="/2022/09/27/SpringCloud/image-20220913162245171.png" alt="image-20220913162245171"></p>
<p><font color="yellow">注：要被监控的话，所有的微服务提供者必须有actuator依赖</font></p>
<p>修改8001的主启动类：主要是添加下头的配置</p>
<p>新版本 Hystrix 要在主启动类中指定监控路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 注册进 eureka</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentHystrixMain8001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentHystrixMain8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *此配置是为了服务监控而配置，与服务容错本身无关，springcloud升级后的坑</span></span><br><span class="line"><span class="comment">     * ServletRegistrationBean因为springboot的默认路径不是&quot;/hystrix.stream&quot;</span></span><br><span class="line"><span class="comment">     * 只要在自己的项目里配置上下面的servlet就可以了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HystrixMetricsStreamServlet streamServlet = <span class="keyword">new</span> HystrixMetricsStreamServlet();</span><br><span class="line">        ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(streamServlet);</span><br><span class="line">        registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        registrationBean.addUrlMappings(<span class="string">&quot;/hystrix.stream&quot;</span>);</span><br><span class="line">        registrationBean.setName(<span class="string">&quot;HystrixMetricsStreamServlet&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试：打开9001、7001、8001</p>
<p><img src="/2022/09/27/SpringCloud/image-20220913164018159.png" alt="image-20220913164018159"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:8001/payment/circuit/33">http://localhost:8001/payment/circuit/33</a> 和 <a target="_blank" rel="noopener" href="http://localhost:8001/payment/circuit/-33">http://localhost:8001/payment/circuit/-33</a></p>
<p>多次的请求成功：<img src="/2022/09/27/SpringCloud/image-20220913164136533.png" alt="image-20220913164136533" style="zoom:67%;"></p>
<p>多次的请求失败：断路器打开    <img src="/2022/09/27/SpringCloud/image-20220913164218779.png" alt="image-20220913164218779" style="zoom:67%;"></p>
<p><font color="yellow">怎么看：</font></p>
<ol>
<li><p>7色<img src="/2022/09/27/SpringCloud/image-20220913164632728.png" alt="image-20220913164632728"></p>
</li>
<li><p>1圈：通过颜色变化代表实力的健康程度，绿色&lt;黄色&lt;橙色&lt;红色。流量越大，实心圆就越大，以此可以在大量实例中快速发现<font color="red">故障实例和高压力实例</font><img src="/2022/09/27/SpringCloud/image-20220913164942675.png" alt="image-20220913164942675" style="zoom:80%;"></p>
</li>
<li><p>1线     <img src="/2022/09/27/SpringCloud/image-20220913165012084.png" alt="image-20220913165012084"></p>
</li>
<li><p>整图说明<img src="/2022/09/27/SpringCloud/image-20220913165053249.png" alt="image-20220913165053249"></p>
</li>
</ol>
<h2 id="十三、服务网关-gateway"><a href="#十三、服务网关-gateway" class="headerlink" title="十三、服务网关 gateway"></a>十三、服务网关 gateway</h2><p>(技术快速迭代，构建体系，配置变多了。编码很重要，但得知道是干嘛的)</p>
<p>zuul服务网关和gateway新一代服务网关；zuul不再被维护，所以<strong>主要使用gateway</strong></p>
<p>谈谈对微服务网关的了解？</p>
<p>​    微服务网关是整个微服务API请求的入口，可以实现过滤Api接口。<br>​    作用：可以实现用户的验证登录、解决跨域、日志拦截、权限控制、限流、熔断、负载均衡、黑名单与白名单机制等。</p>
<p>​    </p>
<p>过滤器和网关的区别：过滤器适合单个服务实现过滤请求。网关拦截整个的微服务实现过滤请求，能够解决整个微服务中冗余代码。过滤器是局部拦截，网关实现全局拦截</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">网关使用的是哪一个，为什么要用 gateway？比 zuul 好在哪？</span><br><span class="line">	Gateway，该项目借助Spring WebFlux的能力，打造了一个API网关。旨在提供一种简单而有效的方法来作为API服务的路由，并为它们提供各种增强功能，例如：安全性，监控和可伸缩性。</span><br><span class="line">	Zuul网关属于netflix公司开源产品，属于第一代微服务网关；Gateway属于SpringCloud自研发的网关框架，属于第二代微服务网关。</span><br><span class="line">	Zuul网关底层基于Servlet实现，阻塞式Api，不支持长连接。SpringCloudGateway基于Spring5构建，能够实现响应式非阻塞式的Api，支持长连接，能够更好的整合Spring体系的产品，依赖SpringBooot-WebFux</span><br></pre></td></tr></table></figure>

<p>​    Cloud全家桶中有个很重要的组件就是网关，在1.x版本中采用的都是Zuul网关，2.x版本中，zuul的升级一直跟不上，SpringCloud自己研发了一个网关替代Zuul<font color="yellow">gateway是原zuul1.x版的替代</font></p>
<p><img src="/2022/09/27/SpringCloud/image-20220914092459847.png" alt="image-20220914092459847"></p>
<p>​    SpringCloud Gateway 作为SpringCloud生态系统中的网关，目标是代替 Zuul，在SpringCloud 2.0以上版本中，没有对新版本的Zuul 2.0以上最新高性能版本集成，仍然使用Zuul 1.x非Reactor模式的老版本。而为了提升网关性能，<font color="yellow">SpringCloud Gateway是基于WebFlux框架实现的，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty</font></p>
<p>​    SpringCloud Gateway 使用的Webflux中的reactor-netty响应式编程组件，底层使用了Netty通讯框架</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">微服务网关能干嘛？</span><br><span class="line">反向代理、鉴权、流量控制、熔断、日志监控</span><br></pre></td></tr></table></figure>

<img src="/2022/09/27/SpringCloud/image-20220914094157504.png" alt="image-20220914094157504" style="zoom: 50%;">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SpringCloud Gateway具有如下特性：</span><br><span class="line">1.基于Spring Framework 5，Project Reactor 和SpringBoot 2.0 进行创建</span><br><span class="line">2.动态路由：能够匹配任何请求属性。（重要）</span><br><span class="line">3.可以对路由指定 Predicate（断言）和 Filter（过滤器）。（重要）</span><br><span class="line">4.集成Hystrix的断路器功能</span><br><span class="line">5.集成 SpringCloud 服务发现功能</span><br><span class="line">6.易于编写 Predicate 和 Filter</span><br><span class="line">7.请求限流功能</span><br><span class="line">8.支持路径重写</span><br></pre></td></tr></table></figure>





<p><font color="pink">Zuul1.x模型：</font></p>
<p>SpringCloud中所集成的Zuul版本，采用的式Tomcat容器，使用的是传统的Servlet IO处理模型</p>
<p><font color="yellow">Servlet的生命周期？</font>servlet由servlet container进行生命周期管理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">container启动时创造servlet对象并调用servlet init()进行初始化；</span><br><span class="line">container运行时接受请求，并为每个请求分配一个线程(一般从线程池中获取空闲线程)然后调用service()；</span><br><span class="line">container关闭时调用servlet destory()销毁servlet；</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220914102528926.png" alt="image-20220914102528926"></p>
<p><font color="yellow">上述模式的缺点：</font></p>
<p>​    servlet是一个简单的网络IO模型，当请求进入servlet container容器中时，servlet container就会为其绑定一个线程，在<strong>并发不高的场景下</strong>这种模型是适用的（进来一个请求，就绑定一个线程）。一旦是高并发场景下，线程数量就会上涨，而线程资源代价是昂贵的，严重影响请求的处理时间。在业务场景下，希望只用1个或几个线程就能应对极大并发的请求，这种业务场景下servlet模型没有优势</p>
<p>​    所以Zuul 1.x是<font color="red">基于servlet之上的一个阻塞式处理模型</font>，即spring实现了处理所有request请求的一个servlet并由该servlet阻塞式处理。</p>
<p><font color="pink">Gateway模型：</font></p>
<p>​    传统的web框架，如：struts2，springmvc等都是基于Servlet API与Servlet容器基础上运行的</p>
<p>但<strong>Servlet3.1之后有了异步非阻塞的支持</strong>。而WebFlux是一个典型非阻塞异步的框架，核心是基于Reactor的相关API实现的。相对于传统web框架来说，它可以运行在诸如Netty，Undertow及支持Servlet3.1的容器上。非阻塞式+函数式编程</p>
<p><font color="pink">现在玩的都是响应式异步非阻塞模型</font></p>
<p>响应式布局：一个网站能够兼容多个终端。面对不同分辨率设备灵活性强，能够快捷解决多设备显示适应问题。</p>
<p>异步：多个任务执行或发生，可以并发地执行。（同步：多个任务执行或发生，必须逐个地进行执行）</p>
<p>阻塞：当某个事件或任务执行过程中，发出一个请求，但由于请求操作需要的条件不满足，会一直等待，直至条件满足</p>
<p>非阻塞：当某个事件或任务执行过程中，发出一个请求，如果请求操作条件不满足，会立即返回一个标志信息（如：暂时无法访问，诸如此类）</p>
<h3 id="1-gateway三大核心概念"><a href="#1-gateway三大核心概念" class="headerlink" title="1. gateway三大核心概念"></a>1. gateway三大核心概念</h3><p>Router(路由)：路由是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由(符合路由的匹配、转发规则)</p>
<p>Predicate(断言)：参考的是Java8的 java.util.function.Predicate，开发人员可以匹配HTTP请求中的所有内容(例如请求头或请求参数),<font color="yellow">如果请求与断言相匹配则进行路由</font></p>
<p>Filter(过滤)：指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或之后对请求进行修改(断言过来后，还可以设置一些过滤条件)</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914111750199.png" alt="image-20220914111750199"></p>
<p><font color="pink">Gateway工作流程</font></p>
<p><img src="/2022/09/27/SpringCloud/image-20220914112001175.png" alt="image-20220914112001175"></p>
<p>客户端向 SpringCloud Gateway 发出请求。然后在 Gateway Handler Mapping 中找到与请求相匹配的路由，将其发送到 Gateway Web Handler。</p>
<p>Handler再通过指定的过滤器链来将请求发送到我们实际的服务执行逻辑中，然后返回。</p>
<p>过滤器间用虚线分开是因为过滤器可能会在发送代理请求之前(“pre”)或之后(“post”)执行业务逻辑</p>
<p>Filter在”pre”类型的过滤器可以做参数校验、权限校验、流量监控、日志输出、协议转换等</p>
<p>在”post”类型的过滤器可以做响应内容、响应头的修改，日志的输出，流量监控等</p>
<p><font color="yellow">核心逻辑：路由转发+执行过滤器链</font></p>
<h3 id="2-基本配置"><a href="#2-基本配置" class="headerlink" title="2. 基本配置"></a>2. 基本配置</h3><p>新建网关工程：cloud-gateway-gateway9527</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914141745044.png" alt="image-20220914141745044"></p>
<p>pom：没有 web和actuator 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--gateway--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>gateway 依赖中集成了 webflux 和 reactor-netty (非阻塞式响应式编程的高性能框架)</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914142144565.png" alt="image-20220914142144565"></p>
<p>yml：网关也要注册到注册中心(Eureka、Consul、Zookeeper都行)</p>
<p>​    实现路由映射：cloud-provider-payment8001 controller的两个接口，get和lb</p>
<p>​    不想暴漏8001，希望在8001外头套一层9527</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914142455266.png" alt="image-20220914142455266"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>          <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 能找到-----为true，就访问</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span>            <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>          <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>            <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 服务提供者provider注册进eureka服务列表内</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<img src="/2022/09/27/SpringCloud/image-20220914142622963.png" alt="image-20220914142622963" style="zoom:50%;">

<p>主启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GateWayMain9527</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GateWayMain9527.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>启动7001、8001、9527</p>
<p>两个微服务均被注册到Eurka；自测8001接口没问题，把接口改为9527</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914142825008.png" alt="image-20220914142825008"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220914142843243.png" alt="image-20220914142843243"></p>
<p>断言规则：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914143713912.png" alt="image-20220914143713912"></p>
<h3 id="3-gateway配置动态路由"><a href="#3-gateway配置动态路由" class="headerlink" title="3. gateway配置动态路由"></a>3. gateway配置动态路由</h3><p>存在的问题：yml配置中路径是写死的，我们需要实现负载均衡<img src="/2022/09/27/SpringCloud/image-20220914152205782.png" alt="image-20220914152205782"></p>
<p><font color="pink">通过微服务名实现动态路由</font></p>
<p>​    默认情况下Gateway会根据注册中心注册的服务列表，以注册中心上微服务名为路径创建<strong>动态路由进行转发，从而实现动态路由的功能</strong></p>
<p>启动：一个Eureka7001 + 两个服务提供 8001/8002</p>
<p>pom：spring-cloud-starter-netflix-eureka-client</p>
<p>yml配置：uri：统一资源标识符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">需要注意的是 uri 的协议为lb，表示启用Gateway的负载均衡功能</span><br><span class="line"></span><br><span class="line">lb://serviceName是spring cloud gateway 在微服务中自动为我们创建的负载均衡 uri</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启从注册中心动态创建路由的功能，利用微服务名进行路由</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="comment">#uri: http://localhost:8001          #匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span>     <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span>            <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="comment">#uri: http://localhost:8001          #匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span>     <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>            <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 服务提供者provider注册进eureka服务列表内</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>通过服务名去查找</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914153858596.png" alt="image-20220914153858596"></p>
<p>测试：发现两个接口在不停的互换</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914153957448.png" alt="image-20220914153957448"><img src="/2022/09/27/SpringCloud/image-20220914154014752.png" alt="image-20220914154014752"></p>
<h3 id="4-Predicate的使用"><a href="#4-Predicate的使用" class="headerlink" title="4. Predicate的使用"></a>4. Predicate的使用</h3><p>启动时会自动扫描配置；即 yml 中配置的 predicates</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914182556731.png" alt="image-20220914182556731"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220914183425573.png" alt="image-20220914183425573"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220914191618007.png" alt="image-20220914191618007"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">After=2022-09-14T18:29:48.268+08:00[Asia/Shanghai]</span> <span class="comment">#在这个时间后才能访问(时区是上海时间)</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Cookie=username,yyds</span> <span class="comment"># 需要携带Cookie才能访问</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span>      <span class="comment"># 请求头要有X-Request-Id属性并且值为整数的正则表达式</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Host=**.atguigu.com</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Method=GET</span>            <span class="comment"># 必须是get请求</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>            <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Query=username,</span> <span class="string">\d+</span>   <span class="comment"># 要有参数名username并且值是正整数才能路由</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p><font color="pink">After Route Predicate</font></p>
</li>
<li><p><font color="pink">Before Route Predicate</font></p>
</li>
<li><p><font color="pink">Between Route Predicate</font></p>
<p><em>Before 、Between 和After同理</em></p>
</li>
<li><p><font color="pink">Cookie Route Predicate </font>：带Cookie和不带Cookie</p>
<p>需要两个参数，一个是Cookie name，一个是正则表达式。</p>
<p>路由规则会通过获取对应的Cookie name 值和正则表达式去匹配，如果匹配上就执行路由，没匹配上就不执行</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">测试工具一般有：Jmeter、Postman（图形界面）、curl（看成是postman的底层命令）</span><br></pre></td></tr></table></figure>

<p>使用 curl 测试，cmd中；默认发送的是 Get请求</p>
<p>发送post请求： curl -X POST “http://…”</p>
<p>不带Cookie：curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a></p>
<img src="/2022/09/27/SpringCloud/image-20220914185803489.png" alt="image-20220914185803489" style="zoom:67%;">

<p>带Cookie：curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> –cookie “username=yyds”</p>
<p><img src="/2022/09/27/SpringCloud/image-20220914190132655.png" alt="image-20220914190132655"></p>
<ol start="5">
<li><p><font color="pink">Header Route Predicate</font>: 一个属性名称和一个正 表达式，属性值和正则表达式匹配则执行</p>
<p>测试：请求头包含的是正整数，即可正确匹配</p>
<p>curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> -H “X-Request-Id:123”  </p>
<p><img src="/2022/09/27/SpringCloud/image-20220914192656106.png" alt="image-20220914192656106"></p>
</li>
<li><p><font color="pink">Host Route Predicate</font>:加正确的请求地址才能匹配；不加直接报错</p>
<p>curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> -H “Host: <a target="_blank" rel="noopener" href="http://www.atguigu.com&quot;/">www.atguigu.com&quot;</a>  </p>
<p>curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> -H “Host: new.atguigu.com”  </p>
</li>
<li><p><font color="pink">Method Route Predicate</font>：规定请求方法（GET/POST…）</p>
</li>
<li><p><font color="pink">Path Route Predicate</font>：路径</p>
</li>
<li><p><font color="pink">Query Route Predicate</font>：加参数名</p>
<p>curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb?username=31">http://localhost:9527/payment/lb?username=31</a></p>
</li>
</ol>
<p><strong>总结：Predicate就是为了实现一组匹配规则，让请求过来找到对应的Route进行处理</strong></p>
<h3 id="5-gateway的Filter的使用"><a href="#5-gateway的Filter的使用" class="headerlink" title="5. gateway的Filter的使用"></a>5. gateway的Filter的使用</h3><p>是什么：路由过滤器可用于修改进入的HTTP请求和返回的HTTP响应，路由过滤器只能指定路由进行使用</p>
<p>Spring Cloud Gateway 内置了多种路由过滤器，他们都由GatewayFilter的工厂来产生</p>
<p>种类：</p>
<p>​    1.GatewayFilter   单一的—31钟</p>
<p>​    2.GlobalFilter       全局的—10种</p>
<p><font color="pink">自定义全局过滤器 GlobalFilter</font></p>
<p><font color="yellow">使用前先把yml里请求中需要携带信息的断言配置注释掉</font></p>
<p>两个主要接口：implements  GlobalFilter，Ordered</p>
<p><em>能干嘛：</em>全局日志记录，统一网关鉴权…</p>
<img src="/2022/09/27/SpringCloud/image-20220915102209467.png" alt="image-20220915102209467" style="zoom:80%;">

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 容器注入(在包下想要被扫描到一定要加的配置)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLogGatewayFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// chain:过滤器链</span></span><br><span class="line">        log.info(<span class="string">&quot;********come in MyLogGatewayFilter:    &quot;</span> + <span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">        String uname = exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uname == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;******用户名为null，非法用户，(T__T)&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加载过滤器的顺序，数字越小，优先级越高</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动7001、8001、8002、9527</p>
<p>正确地址：<a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb?uname=sd">localhost:9527/payment/lb?uname=sd</a></p>
<p>uname 的值是多少都行</p>
<p><img src="/2022/09/27/SpringCloud/image-20220915103140241.png" alt="image-20220915103140241"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220915112337654.png" alt="image-20220915112337654"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220915103228782.png" alt="image-20220915103228782" style="zoom:67%;"><img src="D:/Typora/images/image-20220915103255817.png" alt="image-20220915103255817" style="zoom:67%;"></p>
<p><strong>ServerWebExchange接口：服务网络交换器</strong>，存放着重要的请求-响应属性、请求实例和响应实例等等</p>
<p>​    ServerHttpRequest接口：用于承载请求相关的属性和请求体</p>
<p>​    ServerHttpResponse接口：用于承载响应相关的属性和响应体</p>
<h3 id="gateway小结"><a href="#gateway小结" class="headerlink" title="gateway小结"></a>gateway小结</h3><p>​    过滤器是线性结构，只要设置了都会一个一个进入；一般放在全局配置。断言则是过滤器之后设置在接口上的规则，需要哪些请求信息</p>
<p>断言是用来判断访问是否符合路由规则，不符合报错404</p>
<p>过滤器是判断请求中是否有我要的信息，报错406</p>
<h2 id="十四、-SpringCloud-Config-分配式配置中心"><a href="#十四、-SpringCloud-Config-分配式配置中心" class="headerlink" title="十四、 SpringCloud Config 分配式配置中心"></a>十四、 SpringCloud Config 分配式配置中心</h2><p>大多配合使用：Config+Bus    后期逐渐被 Nacos 所替代</p>
<p><strong>当前微服务工程面对的问题：</strong>项目越来越多，重复的配置文件也越来越多。我们希望做到一次配置，处处生效</p>
<p>​    微服务意味着将单体应用中的业务拆分成一个个的子服务，每个服务的粒度相对较小，因此系统中会出现大量的服务。由于每个服务都需要必要的配置信息才能运行，所以一个集中式、动态的配置管理设施是必不可少的。</p>
<p>​    SpringCloud提供了ConfigServer来解决这个问题，如果每一个微服务都有一个application.yml，那上百个配置文件。。。想想都恐怖</p>
<p><img src="/2022/09/27/SpringCloud/image-20220915144556950.png" alt="image-20220915144556950"></p>
<p><font color="pink">配置中心是什么：</font>SpringCloud Config 为微服务架构中的微服务<strong>提供集中化的外部配置支持（一般就是Git或Github）</strong>，配置服务器为各个不同微服务应用的所有环境提供了一个中心化的外部配置</p>
<p><font color="pink">怎么用：</font>SpringCloud Config 分为<strong>服务端和客户端两部分</strong></p>
<p>​    服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密、解密信息等访问接口</p>
<p>​    客户端通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动时从配置中心获取和加载配置信息。配置服务器默认采用git来存储信息，这样有助于对环境配置进行版本处理，并可以通过git客户端工具来方便管理和访问配置内容</p>
<p><font color="pink">能干嘛：</font></p>
<ol>
<li>集中管理配置文件</li>
<li>不同环境不同配置，动态化更新配置，分环境部署(dev/test/prod/beta/release)–(开发环境/测试/生产/预发布/发布)</li>
<li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心统一拉取配置自己的信息</li>
<li>当配置发生变动时，服务不需要重启即可感知到配置的变化并应用新的配置</li>
<li>将配置中心以REST接口的形式暴露——post、curl访问刷新均可</li>
</ol>
<p><strong>和GitHub整合使用：</strong>由于SpringCloud Config默认使用Git来存储配置文件(SVN和本地文件也可)，但最推荐Git，而且使用的是http/https访问的形式</p>
<p><strong>项目启动时去配置中心拉自己所需的配置</strong></p>
<h2 id="十五、-SpringCloud-Bus消息总线"><a href="#十五、-SpringCloud-Bus消息总线" class="headerlink" title="十五、 SpringCloud Bus消息总线"></a>十五、 SpringCloud Bus消息总线</h2><p>问题：</p>
<ol>
<li>config只能手动刷新，我们想做到自动刷新；</li>
<li>假如100台机子，想要实现全部刷新怎么办</li>
<li>怎么精确刷新，比如只更新98台，剩下2台不刷新</li>
</ol>
<p><strong>Bus支持两种消息代理：RabbitMQ 和 Kafka</strong></p>
<p><img src="/2022/09/27/SpringCloud/image-20220916145617320.png" alt="image-20220916145617320"></p>
<p>通过消息中间件来推送</p>
<p>SpringCloud Bus是用来将分布式系统的节点与轻量级消息系统链接起来的框架，<font color="yellow">它整合了Java的事件处理机制和消息中间件的功能</font></p>
<p>第1、2步，推送新的配置到git，更新到配置中心里；第3步，POST请求广播全局刷新</p>
<p><font color="pink">什么是总线：</font></p>
<p>​    微服务架构系统中，通常会使用<strong>轻量级的消息代理</strong>来构建一个<strong>共用的消息主题</strong>，并让系统中所有微服务实例都连接上来。<em><strong>由于该主题的消息会被所有实例监听和消费，所有称为消息总线</strong></em>。在总线上的各个实例，都能广播一些让连接在该主题上的其他实例都知道的消息</p>
<p><font color="pink">基本原理：</font></p>
<p>​    ConfigClient实例都监听MQ中同一个topic(默认是SpringCloudBus)。当一个服务刷新数据时，它会把这个信息放到topic中，这样其他监听同一个topic的服务就能得到通知，在更新自身配置</p>
<h3 id="安装RabbitMQ"><a href="#安装RabbitMQ" class="headerlink" title="安装RabbitMQ"></a>安装RabbitMQ</h3><p>RabbitMQ需要Erlang环境支持</p>
<p>下载Erlang</p>
<p>版本对照表：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/which-erlang.html">RabbitMQ Erlang Version Requirements — RabbitMQ</a></p>
<h2 id="十六、-SpringCloud-Stream-消息驱动"><a href="#十六、-SpringCloud-Stream-消息驱动" class="headerlink" title="十六、 SpringCloud Stream 消息驱动"></a>十六、 SpringCloud Stream 消息驱动</h2><p>消息中间件：基于队列与消息传递技术，在网络环境中为应用系统提供同步或异步、可靠的信息传输的支撑性软件系统</p>
<p>解决的问题：不同端之间（后端和大数据端使用不同的消息中间件）会存在多种MQ(消息中间件)，如：ActiveMQ、RabbitMQ、RocketMQ、Kafka。需要一种新技术，让我们不在关注具体的MQ细节，我们只需要用一种适配绑定的方式，自动可以在各种MQ内切换。</p>
<p><font color="pink">SpringCloud Stream</font></p>
<p>​    是一个构建消息驱动微服务的框架，我们通过配置来binding(绑定)，而SpringCloud Stream的<strong>binder</strong>对象负责与消息中间件交互。</p>
<p>​    <strong>目前仅支持RabbitMQ、Kafka</strong></p>
<p>标准的MQ：<img src="/2022/09/27/SpringCloud/image-20220919092659451.png" alt="image-20220919092659451"></p>
<p>生产者、消费者之间靠<strong>消息</strong>媒介传递信息内容——Message</p>
<p>消息必须走特定的<strong>通道</strong>——–消息通道MessageChannel</p>
<p>消息通道里的消息如何被消费，谁负责收发<strong>处理</strong>——–消息通道MessageChannel的子接口SubscribableChannel，由MessageHandler消息处理器所订阅（订阅就发送，不订阅就不发送）</p>
<p>引入Stream</p>
<p><img src="/2022/09/27/SpringCloud/image-20220919093818379.png" alt="image-20220919093818379"></p>
<p>这些中间件的差异性，对我们实际项目开发造成一定的困扰性，如果我们用了两个消息队列的其中一种，后面的业务需求需要使用另外一种，很多东西都要推倒重做，因为和系统耦合了，这时SpringCloud Stream给我们提供了一种解耦合的方式</p>
<p>​    通过定义绑定器作为中间层，完美实现<font color="yellow">应用程序与消息中间件细节之间的隔离</font>。通过向应用程序暴露统一的Channel通道，使应用程序不需要考虑各种不同的消息中间件实现</p>
<p><font color="yellow">通过定义绑定器Binder作为中间层，实现了应用程序与消息中间件细节之间的隔离</font></p>
<p>Binder：INPUT对应消费者      OUTPUT对应生产者</p>
<h3 id="1-Stream标准流程套路"><a href="#1-Stream标准流程套路" class="headerlink" title="1. Stream标准流程套路"></a>1. Stream标准流程套路</h3><img src="/2022/09/27/SpringCloud/image-20220919101013778.png" alt="image-20220919101013778" style="zoom: 50%;">

<img src="/2022/09/27/SpringCloud/image-20220919101043845.png" alt="image-20220919101043845" style="zoom: 50%;">

<ul>
<li>Binder—–方便的连接中间件，屏蔽差异</li>
<li>Channel——通道，是队列Queue的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过Channel对队列进行配置</li>
<li>Source和Sink—– 简单理解为参照对象是SpringCloud Stream自身，从Stream发布消息就是输出，接受消息就是输入</li>
</ul>
<p><img src="/2022/09/27/SpringCloud/image-20220919101553918.png" alt="image-20220919101553918"></p>
<h3 id="2-消息驱动生产者"><a href="#2-消息驱动生产者" class="headerlink" title="2. 消息驱动生产者"></a>2. 消息驱动生产者</h3><p>cloud-steam-rabbitmq-provider8801</p>
<p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--stream-rabbit--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        web启动器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        监控接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">output:</span> <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span>  <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line"><span class="comment">#  instance:</span></span><br><span class="line"><span class="comment">#    lease-renewal-interval-in-seconds: 2 # 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line"><span class="comment">#    lease-expiration-duration-in-seconds: 5 # 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line"><span class="comment">#    instance-id: send-8801.com  # 在信息列表时显示主机名称-发送者8801</span></span><br><span class="line"><span class="comment">#    prefer-ip-address: true     # 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>

<p>主启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudStreamRabbitmqProvider8801Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(CloudStreamRabbitmqProvider8801Application.class, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;启动成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service: 和消息中间件打交道的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMessageProviderService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义消息的推送管道--消息的发送者</span></span><br><span class="line">    <span class="function">String <span class="title">send</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Source;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调的是消息中间件的service，不是dao层，所以用的不是@Service注解</span></span><br><span class="line"><span class="meta">@EnableBinding(Source.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProviderServiceImpl</span> <span class="keyword">implements</span> <span class="title">IMessageProviderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output; <span class="comment">// 消息发送管道</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String serial = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">// 消息构造器</span></span><br><span class="line">        output.send(MessageBuilder.withPayload(serial).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;*****serial: &quot;</span> + serial);</span><br><span class="line">        <span class="keyword">return</span> serial;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IMessageProviderService messageProviderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/sendMessage&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messageProviderService.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-消息驱动消费者"><a href="#3-消息驱动消费者" class="headerlink" title="3. 消息驱动消费者"></a>3. 消息驱动消费者</h3><p>cloud-stream-rabbitmq-consumer8802</p>
<p>pom和上头一样</p>
<p>yml: 主要是在 bindings 处修改为 input</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8802</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">input:</span> <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span>  <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line"><span class="comment">#  instance:</span></span><br><span class="line"><span class="comment">#    lease-renewal-interval-in-seconds: 2 # 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line"><span class="comment">#    lease-expiration-duration-in-seconds: 5 # 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line"><span class="comment">#    instance-id: receive-8802.com  # 在信息列表时显示主机名称</span></span><br><span class="line"><span class="comment">#    prefer-ip-address: true     # 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>

<p>主启动</p>
<p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding(Sink.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveMessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(Sink.INPUT)</span> <span class="comment">// 作为一个输入源监听</span></span><br><span class="line">    <span class="comment">// output 发的时候使用的String，这边收就也是 String</span></span><br><span class="line">    <span class="comment">// output 使用的 withPayload，input 收就使用 getPayload</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">input</span><span class="params">(Message&lt;String&gt; message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;port:&quot;</span> + serverPort + <span class="string">&quot;\t接受：&quot;</span> + message.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-分组消费与持久化-重要"><a href="#4-分组消费与持久化-重要" class="headerlink" title="4. 分组消费与持久化 重要*"></a>4. 分组消费与持久化 重要*</h3><p>存在问题：</p>
<ol>
<li>重复消费</li>
<li>消息持久化</li>
</ol>
 <img src="/2022/09/27/SpringCloud/image-20220919163535543.png" alt="image-20220919163535543" style="zoom: 67%;">

<p>​    默认分组或者还没分组时，提供服务方是集群环境，可能会导致一个服务发送过来后，被两个或多个服务获取到。就会造成数据错误；比如可能会扣除两次款</p>
<p><font color="yellow">不同组是可以全面消费的(重复消费)</font></p>
<p><font color="yellow">同一个组内是竞争关系，只有其中一个可以消费</font></p>
<p><strong>自定义分组</strong>：A、B (不自定义就是随机的流水号)   此组即为消费组</p>
<p><img src="/2022/09/27/SpringCloud/image-20220919164846437.png" alt="image-20220919164846437"></p>
<img src="/2022/09/27/SpringCloud/image-20220919165343013.png" alt="image-20220919165343013" style="zoom:67%;">

<img src="/2022/09/27/SpringCloud/image-20220919165409551.png" alt="image-20220919165409551" style="zoom:67%;">

<p>同一个组的多个微服务案例，每次只会有一个获取调用，会轮询调用</p>
<p><strong>持久化</strong>：避免消息丢失(添加分组后)</p>
<p>​    在业务死掉后重启，依然可以获取业务停止时请求的服务信息</p>
<h2 id="十七、-SpringCloud-Sleuth-分布式请求链路跟踪"><a href="#十七、-SpringCloud-Sleuth-分布式请求链路跟踪" class="headerlink" title="十七、 SpringCloud Sleuth 分布式请求链路跟踪"></a>十七、 SpringCloud Sleuth 分布式请求链路跟踪</h2><p><font color="pink">为什么会出现这项技术：</font></p>
<p>​    在微服务框架中，一个由客户端发起的请求在后端会调用多个不同的服务节点来协同得到最后的结果，每一个前端请求都会形成一个复杂的分布式服务调用链路，链路中任何一环出现高延时或错误都会引起整个请求的最后失败</p>
<p>获得每一个调用节点的完整的轨迹图</p>
<p>SpringCloud Sleuth提供了一套完整的服务跟踪的解决方案，在分布式系统中提供追踪解决方案并兼容支持zipkin</p>
<img src="/2022/09/27/SpringCloud/image-20220919190446834.png" alt="image-20220919190446834" style="zoom:50%;">

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>下载zipkin jar包<a target="_blank" rel="noopener" href="https://repo1.maven.org/maven2/io/zipkin/zipkin-server/">Central Repository: io/zipkin/zipkin-server (maven.org)</a></p>
<img src="/2022/09/27/SpringCloud/image-20220919191215337.png" alt="image-20220919191215337" style="zoom: 80%;">

<p>也就是 sleuth 整合了 zipkin；或者说SpringCloud借鉴了zipkin然后换了个名字</p>
<p>运行jar包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar zipkin-server-2.23.9-exec.jar</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220919191532515.png" alt="image-20220919191532515"></p>
<p>访问：localhost：9411</p>
<p><img src="/2022/09/27/SpringCloud/image-20220919191557173.png" alt="image-20220919191557173"></p>
<p>​    一个完整的请求链路，每条链路都用一个Trace Id唯一标识，Span标识发起的请求信息，各Span通过 parent id 关联起来</p>
<p><img src="/2022/09/27/SpringCloud/image-20220919191923670.png" alt="image-20220919191923670"></p>
<p>Trace：类似于树结构的Span集合，表示一条调用链路，存在唯一标识</p>
<p>span：标识调用链路来源，通俗理解span就是一次请求信息</p>
<p>案例：使用8001和888做示范</p>
<p><img src="/2022/09/27/SpringCloud/image-20220919193604606.png" alt="image-20220919193604606"></p>
<p>pom：两个都新增</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--包含了sleuth+zipkin--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>8001 yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">  	<span class="comment"># 内容发布到9411</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="comment"># 采样率值介于 0 到 1 之间，1 表示全部采集；一般不用设为 1</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220919193246798.png" alt="image-20220919193246798"></p>
<p>8001 controller: 写一个简单的测试接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/zipkin&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentZipkin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hi, I am paymentZipkin server fall back, welcome to here ^_^&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>888 yml：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220919193804706.png" alt="image-20220919193804706"></p>
<p>888 controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ====&gt; zipkin + sleuth</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/zipkin&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentZipkin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String result = restTemplate.getForObject(<span class="string">&quot;http://localhost:8001&quot;</span> + <span class="string">&quot;/payment/zipkin/&quot;</span>, String.class);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依次启动 7001/8001/888</p>
<p>多次调用查看zipkin的内容</p>
<p><img src="/2022/09/27/SpringCloud/image-20220919194743940.png" alt="image-20220919194743940"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220919194752736.png" alt="image-20220919194752736"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220919194840893.png" alt="image-20220919194840893"></p>
<h2 id="十八、-SpringCloud-Alibaba简介"><a href="#十八、-SpringCloud-Alibaba简介" class="headerlink" title="十八、 SpringCloud Alibaba简介"></a>十八、 SpringCloud Alibaba简介</h2><p>SpringCloud Netflix项目进入维护模式(不再开发新的组件)</p>
<p>官网：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-alibaba">Spring Cloud Alibaba</a></p>
<p>英文：<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba">https://github.com/alibaba/spring-cloud-alibaba</a></p>
<p><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html</a></p>
<p>中文：<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/2.2.x/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/2.2.x/README-zh.md</a></p>
<h2 id="十九、-SpringCloud-Alibaba-Nacos服务注册和配置中心"><a href="#十九、-SpringCloud-Alibaba-Nacos服务注册和配置中心" class="headerlink" title="十九、 SpringCloud Alibaba Nacos服务注册和配置中心"></a>十九、 SpringCloud Alibaba Nacos服务注册和配置中心</h2><p>前四个字母是Naming和Configuration的前两个字母，最后s为Service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nacos：一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</span><br></pre></td></tr></table></figure>

<p>Nacos就是注册中心+配置中心的组合  ====》Nacos = Eureka +Config + Bus</p>
<h3 id="1-下载和安装"><a href="#1-下载和安装" class="headerlink" title="1. 下载和安装"></a>1. 下载和安装</h3><p>官网：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos">https://github.com/alibaba/nacos</a></p>
<p>下载：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/">https://nacos.io/zh-cn/</a></p>
<p>下载后解压：<img src="/2022/09/27/SpringCloud/image-20220920102721472.png" alt="image-20220920102721472"></p>
<p>进入bin目录下，cmd打开，单机模式下启动：   <strong>startup.cmd -m standalone</strong></p>
<p><img src="/2022/09/27/SpringCloud/image-20220920102853858.png" alt="image-20220920102853858"></p>
<p>访问地址：localhost:8848/nacos</p>
<p>默认用户名和密码：nacos</p>
<p><img src="/2022/09/27/SpringCloud/image-20220920103015574.png" alt="image-20220920103015574"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220920103038835.png" alt="image-20220920103038835"></p>
<h3 id="2-Nacos-作服务注册中心"><a href="#2-Nacos-作服务注册中心" class="headerlink" title="2. Nacos 作服务注册中心"></a>2. Nacos 作服务注册中心</h3><h4 id="1-gt-服务提供者"><a href="#1-gt-服务提供者" class="headerlink" title="1&gt; 服务提供者"></a>1&gt; 服务提供者</h4><p><strong>new Moudle</strong>：cloudAlibaba-provider-payment9001</p>
<p>配置的案例跟官网走就好：<a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html</a></p>
<p><img src="/2022/09/27/SpringCloud/image-20220920140404693.png" alt="image-20220920140404693"></p>
<p>父pom中：springcloud alibaba 的依赖版本是 2.1.0.RELEASE</p>
<p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringBoot 整合web组件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span>  <span class="comment">#配置Nacos地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把要监控的东西暴露出来</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>main启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain9001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain9001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nacos registry, serverport: &quot;</span> + serverPort + <span class="string">&quot;\t id&quot;</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：启动 nacos，启动9001</p>
<p><img src="/2022/09/27/SpringCloud/image-20220920140841727.png" alt="image-20220920140841727"></p>
<p>为方便演示负载均衡，创建一个相同的9002</p>
<p><img src="/2022/09/27/SpringCloud/image-20220920142126064.png" alt="image-20220920142126064"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220920142311167.png" alt="image-20220920142311167"></p>
<h4 id="2-gt-服务消费者"><a href="#2-gt-服务消费者" class="headerlink" title="2&gt; 服务消费者"></a>2&gt; 服务消费者</h4><p>cloudAlibaba-consumer-nacos-order83</p>
<p><img src="/2022/09/27/SpringCloud/image-20220920144757836.png" alt="image-20220920144757836"></p>
<p>pom：都差不多的</p>
<p>nacos默认自带负载均衡</p>
<p><img src="/2022/09/27/SpringCloud/image-20220920144904376.png" alt="image-20220920144904376"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringBoot 整合web组件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml：把微服务地址直接配置在配置文件中，就不用业务类里定义了</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span>  <span class="comment">#配置Nacos地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把微服务名称写到配置文件中，业务代码中就不用写了，直接引入</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>

<p>config: 负载均衡配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// 通过微服务命令找到了，但其下有很多实例，不知道该用哪个；所以需要该注解</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNacosController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverURL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(serverURL+<span class="string">&quot;/payment/nacos/&quot;</span>+id,String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主启动就是正常：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br></pre></td></tr></table></figure>

<p>启动 nacos/9001/9002/83</p>
<p><img src="/2022/09/27/SpringCloud/image-20220920145122956.png" alt="image-20220920145122956"></p>
<h4 id="3-gt-Nacos-注册中心对比"><a href="#3-gt-Nacos-注册中心对比" class="headerlink" title="3&gt; Nacos 注册中心对比"></a>3&gt; Nacos 注册中心对比</h4><p><font color="pink">支持CP 和 AP 之间切换</font></p>
<p>Nacos的一致性协议： CP+AP</p>
<p><img src="/2022/09/27/SpringCloud/image-20220920145958869.png" alt="image-20220920145958869"></p>
<p><font color="yellow">C:所有节点在同一时间看到的数据是一致的(你有的和我有的是一样的)</font></p>
<p><font color="yellow">A:高可用(行不行的都要给我拽一个)</font></p>
<p>可以使用命令行在 CP 和 AP 之间切换</p>
<h3 id="3-Nacos-作服务配置中心"><a href="#3-Nacos-作服务配置中心" class="headerlink" title="3. Nacos 作服务配置中心"></a>3. Nacos 作服务配置中心</h3><p>cloudAlibaba-config-nacos-client3377</p>
<p>pom: 基本以后用 nacos，就导入 config 和 discovery 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--nacos-config--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web + actuator--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml：两个配置文件</p>
<p>​    Nacos同 springcloud-config 一样，在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置后才能正常启动</p>
<p>springboot中配置文件加载是有优先级的，bootstrap 高于 application</p>
<p>所以全局的放在 bootstrap         自己的放在 application</p>
<p>bootstrap.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nacos 配置</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos 服务注册中心地址</span></span><br><span class="line">      <span class="comment"># 3377 去 Nacos 上去读后缀名为 yaml的文件</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos 配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 指定 yaml 格式的配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span></span><br></pre></td></tr></table></figure>

<p>配置中心配置的命名公式：</p>
<ul>
<li><code>prefix</code> 默认为 <code>spring.application.name</code> 的值，也可以通过配置项<code>spring.cloud.nacos.config.prefix</code>来配置。</li>
<li><code>spring.profiles.active</code> 即为当前环境对应的 profile，详情可以参考 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html#boot-features-profiles">Spring Boot文档</a>。 <strong>注意：当 <code>spring.profiles.active</code> 为空时，对应的连接符 <code>-</code> 也将不存在，dataId 的拼接格式变成 <code>$&#123;prefix&#125;.$&#123;file-extension&#125;</code></strong></li>
<li><code>file-exetension</code> 为配置内容的数据格式，可以通过配置项 <code>spring.cloud.nacos.config.file-extension</code> 来配置。目前只支持 <code>properties</code> 和 <code>yaml</code> 类型。</li>
</ul>
<p><font color="yellow">所以配置文件名为：    nacos-config-client-dev.yaml</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yml是YAML（YAML Ain’t Markup Language）语言的文件</span><br></pre></td></tr></table></figure>



<p>application.yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev  # 表示开发环境</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220921111949481.png" alt="image-20220921111949481"></p>
<p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfigClientMain3377</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(NacosConfigClientMain3377.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span>  <span class="comment">// 支持 Nacos 的动态刷新功能(实现配置自动更新)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 和8848 Nacos 服务器上的配置文件同名</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config/info&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Value 中匹配的是从配置中心拉过来的内容；所以写法是按照配置中心里的配置来写的</p>
<p>详情看下头自己写的 YAML 内容</p>
<p>Nacos 配置</p>
<p><img src="/2022/09/27/SpringCloud/image-20220921092029629.png" alt="image-20220921092029629"></p>
<img src="/2022/09/27/SpringCloud/image-20220921092109404.png" alt="image-20220921092109404" style="zoom:67%;">



<p>名称对应：<img src="/2022/09/27/SpringCloud/image-20220921092158393.png" alt="image-20220921092158393"></p>
<p>启动3377测试：<img src="/2022/09/27/SpringCloud/image-20220921093001459.png" alt="image-20220921093001459"></p>
<p>自带动态刷新：修改Nacos中的yaml配置文件，再次调用查看配置的接口，发现配置已经刷新</p>
<p>​    nacos中修改配置信息</p>
<p><img src="/2022/09/27/SpringCloud/image-20220921093140109.png" alt="image-20220921093140109"></p>
<h3 id="4-Nacos-多环境配置"><a href="#4-Nacos-多环境配置" class="headerlink" title="4. Nacos 多环境配置"></a>4. Nacos 多环境配置</h3><p>​    就像Maven用groupId、artifactId、version三者来定位jar包在仓库中的位置一样，Nacos也提供了 Namespace 、Data ID 、Group  来确定一个配置文件（或者叫配置集）</p>
<p>实现多环境配置方案：</p>
<ol>
<li>命名空间 (namesapce)区分：一个命名空间对应一个环境</li>
<li>配置组 (group)区分：命名空间默认public即可，一个组对应一种环境</li>
<li>配置集ID (Data ID)区分：命名空间和组用默认的，通过文件名来区分</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">多环境多项目管理：</span><br><span class="line">	问题1：</span><br><span class="line">		实际开发中，一个系统通常会有dev，test，prod环境；需要保证指定环境启动时能正确读取到Nacos上相应的配置文件</span><br><span class="line">	问题2：</span><br><span class="line">		一个大型分布式微服务会有很多微服务子项目，每个子项目又会有很多相应的环境</span><br></pre></td></tr></table></figure>

<p>配置管理：<img src="/2022/09/27/SpringCloud/image-20220921105209346.png" alt="image-20220921105209346"></p>
<p>public 命名空间是兜底的，不能删(想删也删不掉)</p>
<img src="/2022/09/27/SpringCloud/image-20220921105723620.png" alt="image-20220921105723620" style="zoom: 67%;">

<p>最外层 namespace 是用于区分部署环境的，Group 和 DataID逻辑上区分目标对象</p>
<img src="/2022/09/27/SpringCloud/image-20220921105511915.png" alt="image-20220921105511915" style="zoom: 50%;">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">默认情况：</span><br><span class="line">Namespace = public</span><br><span class="line">Group = DEFAULT_GROUP</span><br><span class="line">默认Cluster(集群)是DEFAULT</span><br><span class="line">Instance(实例)</span><br></pre></td></tr></table></figure>



<h4 id="1-gt-DataID配置"><a href="#1-gt-DataID配置" class="headerlink" title="1&gt; DataID配置"></a>1&gt; DataID配置</h4><p><img src="/2022/09/27/SpringCloud/image-20220921111429650.png" alt="image-20220921111429650"></p>
<h4 id="2-gt-Group-分组"><a href="#2-gt-Group-分组" class="headerlink" title="2&gt; Group 分组"></a>2&gt; Group 分组</h4><p>DataID相同，组不同</p>
<p><img src="/2022/09/27/SpringCloud/image-20220921112104705.png" alt="image-20220921112104705"></p>
<p>bootstrap中设置group，设哪个就找哪个</p>
<p><img src="/2022/09/27/SpringCloud/image-20220921112233585.png" alt="image-20220921112233585"></p>
<h4 id="3-gt-Namespace"><a href="#3-gt-Namespace" class="headerlink" title="3&gt; Namespace"></a>3&gt; Namespace</h4><p><img src="/2022/09/27/SpringCloud/image-20220921112747601.png" alt="image-20220921112747601"></p>
<img src="/2022/09/27/SpringCloud/image-20220921112723376.png" alt="image-20220921112723376" style="zoom:67%;">

<p>在不同的 namespace 下建配置就好</p>
<p>使用：在不同 namespace 下创建配置就好</p>
<p><img src="/2022/09/27/SpringCloud/image-20220921135949238.png" alt="image-20220921135949238"></p>
<p>层级结构：namespace &gt; group &gt; data id</p>
<h3 id="5-Nacos-集群和持久化-重要"><a href="#5-Nacos-集群和持久化-重要" class="headerlink" title="5. Nacos 集群和持久化(重要)"></a>5. Nacos 集群和持久化(<em>重要</em>)</h3><p>部署生产集群模式，要在 Linux 环境下部署；使用 MySQL(高可用数据库)</p>
<p>光配到Nacos上还不够，容易出现问题，还要放到数据库中</p>
<img src="/2022/09/27/SpringCloud/image-20220921140806272.png" alt="image-20220921140806272" style="zoom:50%;">

<p>最终的数据源一致（都汇聚到mysql中）</p>
<p>Nacos 自带一个内嵌的数据库–derby ，若启动多个Nacos，数据会存在一致性问题，或配置丢失问题</p>
<p>所以 Nacos 采用集中式存储的方式来支持集群化部署，目前只支持 mysql</p>
<p><strong>Nacos 支持三种部署方式</strong></p>
<ul>
<li>单机模式 - 用于测试和单机试用</li>
<li>集群模式- 用于生产环境，确保高可用</li>
<li>多集群模式 - 用于多数据中心场景</li>
</ul>
<p>单机模式下，把 derby 替换成 mysql，具体参考官网（部署手册 ——– 单机模式支持mysql）：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/deployment.html">https://nacos.io/zh-cn/docs/deployment.html</a></p>
<p>集群模式：<img src="/2022/09/27/SpringCloud/image-20220921145852227.png" alt="image-20220921145852227"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220921145729390.png" alt="image-20220921145729390"></p>
<p><font color="pink">Linux版的下载安装：</font></p>
<p>github上下载Linux版本，到虚拟机中，拷贝到 /opt 下解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nacos-server-1.4.4.tar.gz</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220921162013141.png" alt="image-20220921162013141"></p>
<p>解压后，会有一个nacos文件夹；拷贝到新创建的 mynacos 文件夹中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hspEdu01 opt]<span class="comment"># cp -r nacos /mynacos/</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220921162232625.png" alt="image-20220921162232625"></p>
<p>步骤：</p>
<ol>
<li>Linux 上配置mysql</li>
<li>application.properties 配置修改———把nacos默认的数据库改为指向mysql</li>
<li>Linux 服务器上 nacos 的集群配置 cluster.conf———–梳理出同一集群的端口号，比方三台机器就有三个不同的端口号(IP地址要设置成Linux的地址)</li>
<li>编辑Nacos的启动脚本 start.sh，使它可以接受使用不同端口</li>
<li>Nginx配置，作为负载均衡器</li>
</ol>
<img src="/2022/09/27/SpringCloud/image-20220922103752093.png" alt="image-20220922103752093" style="zoom: 50%;">



<h2 id="二十、-SpringCloud-Alibaba-Sentinel-实现熔断和限流"><a href="#二十、-SpringCloud-Alibaba-Sentinel-实现熔断和限流" class="headerlink" title="二十、 SpringCloud Alibaba Sentinel 实现熔断和限流"></a>二十、 SpringCloud Alibaba Sentinel 实现熔断和限流</h2><p>官网：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/introduction.html">https://sentinelguard.io/zh-cn/docs/introduction.html</a></p>
<p><img src="/2022/09/27/SpringCloud/image-20220922153424783.png" alt="image-20220922153424783"></p>
<p>下载：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">Releases · alibaba/Sentinel (github.com)</a></p>
<p><img src="/2022/09/27/SpringCloud/image-20220922154206331.png" alt="image-20220922154206331"></p>
<p>cmd中运行jar包， 访问localhost：8080，默认用户名和密码 sentinel</p>
<p><img src="/2022/09/27/SpringCloud/image-20220922155757350.png" alt="image-20220922155757350"></p>
<h3 id="1-演示工程"><a href="#1-演示工程" class="headerlink" title="1. 演示工程"></a>1. 演示工程</h3><p>new Moudle：  cloudAlibaba-sentinel-service8401</p>
<p>pom：使用 nacos+sentinel 的话，基本前3个依赖都加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud alibaba sentinel-datasource-nacos 后续持久化使用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web + actuator--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#Nacos 服务注册中心地址</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment">#Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描，直至找到未被占用的端口</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#actuator 端点启用和暴露</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>主启动：</p>
<p>@EnableDiscoveryClient ——– 让注册中心能够发现</p>
<p>@SpringBootApplication</p>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-----------testA&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testB&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-----------testB&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：启动 Nacos、Sentinel，启动微服务</p>
<p>​    因为Sentinel是懒加载机制，需要调用接口后才能看到信息</p>
<p><img src="/2022/09/27/SpringCloud/image-20220923094656289.png" alt="image-20220923094656289"></p>
<h3 id="2-流控规则"><a href="#2-流控规则" class="headerlink" title="2. 流控规则"></a>2. 流控规则</h3><p><font color="pink">流量限制控制规则</font></p>
<img src="/2022/09/27/SpringCloud/image-20220923095115034.png" alt="image-20220923095115034" style="zoom:50%;">

<ul>
<li>资源名：唯一名称，默认请求路径</li>
<li>针对来源：Sentinel 可以针对调用者进行限流，填写微服务名，默认default(不区分来源)</li>
<li>阈值类型/单机阈值：<ul>
<li>QPS(每秒请求数量)：当调用该 api 的QPS达到阈值时，进行限流</li>
<li>线程数：当调用该 api 线程数达到阈值时，进行限流</li>
</ul>
</li>
<li>是否集群</li>
<li>流控模式：<ul>
<li>直接：api达到限流条件时，直接限流</li>
<li>关联：当关联的资源达到阈值时，就限流自己</li>
<li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流） 【api级别的限流】</li>
</ul>
</li>
<li>流控效果：<ul>
<li>快速失败：直接失败，抛异常</li>
<li>Warm Up：根据codeFactor（冷加载因子，默认3）的值，从阈值➗codeFactor，经过预热时长，才达到QPS阈值</li>
<li>排队等待：匀速排队，让请求匀速通过，阈值类型必须设置为QPS，否则无效</li>
</ul>
</li>
</ul>
<p>2.1 流控模式</p>
<p><strong>直接：</strong>    1s请求1次可以，多了直接报错<img src="/2022/09/27/SpringCloud/image-20220923101532204.png" alt="image-20220923101532204"></p>
<p>访问量1s超过1次：默认报错<img src="/2022/09/27/SpringCloud/image-20220923101707345.png" alt="image-20220923101707345"></p>
<p><font color="yellow">思考：当访问失败时，我们需要能够自己处理问题，也就是允许用户自定义</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QPS:每秒允许访问的请求量</span><br><span class="line">线程数:高并发的请求过来(QPS很高)，线程数为1，相当于我前台工作人员只有1个，只能接待一个服务，当前服务未结束，后面再来的就要报错</span><br></pre></td></tr></table></figure>



<p><strong>关联：</strong>当关联的资源达到阈值，就限流自己（连坐效应，比方支付模块到阈值，就限流下单）</p>
<p>当与A关联的B达到阈值时，限流A——–B惹事，A挂了</p>
<p>解释：这边压力大，那边就别进来了</p>
<img src="/2022/09/27/SpringCloud/image-20220923103552569.png" alt="image-20220923103552569" style="zoom:50%;">

<p>模拟：使用 postman 让B不停的请求；访问地址添加进多线程集合组</p>
<p><img src="/2022/09/27/SpringCloud/image-20220923105245997.png" alt="image-20220923105245997"></p>
<p>Run，大批量线程高并发访问B，导致A失败</p>
<p><img src="/2022/09/27/SpringCloud/image-20220923104810531.png" alt="image-20220923104810531"></p>
<p>20个线程结束后，调用A回复正常</p>
<h3 id="3-流控效果"><a href="#3-流控效果" class="headerlink" title="3. 流控效果"></a>3. 流控效果</h3><p>直接 ==》 快速失败（默认的流控处理）</p>
<p><strong>预热：</strong>冷启动的方式；当系统长期无人问津，突然拉高访问量，容易把系统压垮。通过冷启动，让通过的流量缓慢增加，在一段时间内逐渐达到阈值上限。</p>
<p><img src="/2022/09/27/SpringCloud/image-20220923110731919.png" alt="image-20220923110731919"></p>
<p>默认 coldFactor 为3，即请求QPS从（coldFactor /3）经多少预热时间才逐渐升至设定的QPS阈值</p>
<p>例子：阈值为10，预热时间5s</p>
<p>系统初始化阈值为10/3，约为3，即阈值刚开始为3；经过5s后阈值慢慢升高到10</p>
<p><strong>排队等待：</strong>严格控制请求通过的间隔时间，就是让请求以均匀速度通过；对应漏桶算法</p>
<p><img src="/2022/09/27/SpringCloud/image-20220923111530999.png" alt="image-20220923111530999"></p>
<p>匀速排队，让请求以均匀速度通过，阈值类型必须是QPS，否则无效</p>
<p>设置含义：/testB每秒请求1次，超过就排队等待，等待超时时间为20000ms</p>
<p>测试：postman高并发多线程测试即可(一次一堆请求过来)</p>
<h3 id="4-熔断规则"><a href="#4-熔断规则" class="headerlink" title="4. 熔断规则"></a>4. 熔断规则</h3><p><img src="/2022/09/27/SpringCloud/image-20220923134330816.png" alt="image-20220923134330816"></p>
<ul>
<li><p>慢调用比例</p>
<p>指耗时大于阈值RT的请求称为慢调用，阈值RT由用户设置</p>
<p>请求数大于最小请求数并且慢调用的比率大于比例阈值则发生熔断，熔断时长为用户自定义设置。</p>
</li>
<li><p>异常比例（秒级）</p>
<p>QPS &gt;= 5 且异常比例（秒级统计）超过阈值时，触发降级；时间窗口结束后，关闭降级</p>
</li>
<li><p>异常数（分钟级）</p>
<p>异常数（分钟统计）超过阈值时， 触发降级，时间窗口结束后，关闭降级</p>
</li>
</ul>
<h3 id="5-Sentinel-热点key"><a href="#5-Sentinel-热点key" class="headerlink" title="5. Sentinel 热点key"></a>5. Sentinel 热点key</h3>  <img src="/2022/09/27/SpringCloud/image-20220923144309319.png" alt="image-20220923144309319" style="zoom:50%;">

<p>热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K数据</p>
<p><img src="/2022/09/27/SpringCloud/image-20220923153843310.png" alt="image-20220923153843310"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220923153854007.png" alt="image-20220923153854007"></p>
<p>代码设置：设置热点规则后的兜底函数</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;testHotKey&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;deal_testHotKey&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testHotKey</span><span class="params">(<span class="meta">@RequestParam(value = &quot;p1&quot;,required = false)</span> String p1,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="meta">@RequestParam(value = &quot;p2&quot;,required = false)</span> String p2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-------testHotKey&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deal_testHotKey</span><span class="params">(String p1, String p2, BlockException exception)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-------deal_testHotKey,sorry T_T&quot;</span>; <span class="comment">// sentinel系统默认的提示：Blocked by Sentinel (flow limiting)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法testHotKey里面第一个参数只要QPS超过每秒1次，马上降级处理</p>
<p>本来应该是报我自定义的返回信息，这块可能是jar包冲突了所以直接成页面报错信息了 SOS</p>
<p><img src="/2022/09/27/SpringCloud/image-20220923155510881.png" alt="image-20220923155510881"></p>
<p>注： 参数中只要有 p1 就会报问题；如果只携带 p2 是不会触发降级的</p>
<p><strong>参数例外项</strong></p>
<p>只要当 p1=5 时，阈值可变为200</p>
<img src="/2022/09/27/SpringCloud/image-20220923161040379.png" alt="image-20220923161040379" style="zoom:50%;">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@SentinelResource 只管配置出错；若是程序出错，改报异常就是异常</span><br></pre></td></tr></table></figure>



<h3 id="6-SentinelResource"><a href="#6-SentinelResource" class="headerlink" title="6. @SentinelResource"></a>6. @SentinelResource</h3><p>从 HystrixCommand 到 @SentinelResource</p>
<p>8401 项目，pom 导入自定义的 ja r包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>controller</p>
<p>两种方法都可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimitController</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 按资源名测试限流</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/byResource&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;byResource&quot;, blockHandler = &quot;handleException&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">byResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">200</span>,<span class="string">&quot;按资源名称限流测试ok&quot;</span>,<span class="keyword">new</span> Payment(<span class="number">2020L</span>,<span class="string">&quot;serial001&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">handleException</span><span class="params">(BlockException exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">444</span>,exception.getClass().getCanonicalName()+<span class="string">&quot;\t 服务不可用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按 url 测试限流</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rateLimit/byUrl&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;byUrl&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">byUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">200</span>,<span class="string">&quot;按url限流测试ok&quot;</span>,<span class="keyword">new</span> Payment(<span class="number">2020L</span>,<span class="string">&quot;serial002&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动 Nacos、Sentinel、8401</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926093105136.png" alt="image-20220926093105136"></p>
<p>blockHandler：设置了就返回自定义的报错信息；没有就返回系统默认的‘</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926094236294.png" alt="image-20220926094236294"></p>
<p><img src="/2022/09/27/SpringCloud/image-20220926093317513.png" alt="image-20220926093317513"></p>
<p><font color="yellow">限流是临时的，停掉微服务后规则会直接消失</font></p>
<p><font color="red">把降级处理的信息改为统一类，降低 程序的耦合度</font></p>
<p>新建一个类用于统一返回降级信息：</p>
<p> <img src="/2022/09/27/SpringCloud/image-20220926100325572.png" alt="image-20220926100325572"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerBlockHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CommonResult <span class="title">handlerException</span><span class="params">(BlockException exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">4444</span>,<span class="string">&quot;按客户自定义，global handlerException---------1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CommonResult <span class="title">handlerException2</span><span class="params">(BlockException exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">4444</span>,<span class="string">&quot;按客户自定义，global handlerException---------2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller:测试的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试降级的统一返回</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/rateLimit/customerBlockHandler&quot;)</span></span><br><span class="line"><span class="comment">// blockHandlerClass 指定哪个类是统一降级处理的类</span></span><br><span class="line"><span class="comment">// blockHandler 指定使用类中的哪个方法</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;customerBlockHandler&quot;,</span></span><br><span class="line"><span class="meta">                  blockHandlerClass = CustomerBlockHandler.class,</span></span><br><span class="line"><span class="meta">                  blockHandler = &quot;handlerException2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">customerBlockHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">200</span>,<span class="string">&quot;按客户自定义&quot;</span>,<span class="keyword">new</span> Payment(<span class="number">2020L</span>,<span class="string">&quot;serial003&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/27/SpringCloud/image-20220926100905503.png" alt="image-20220926100905503"></p>
<h3 id="7-Sentinel-服务熔断"><a href="#7-Sentinel-服务熔断" class="headerlink" title="7. Sentinel 服务熔断"></a>7. Sentinel 服务熔断</h3><p> Sentinel 整合 ribbon + openFeign + fallback</p>
<p>服务提供者：cloudAlibaba-provider-payment9003/9004      负载均衡</p>
<p>服务消费者：cloudAlibaba-consumer-nacos-order84</p>
<p><font color="red">Ribbon系列</font></p>
<h4 id="1-gt-创建提供者"><a href="#1-gt-创建提供者" class="headerlink" title="1&gt; 创建提供者"></a>1&gt; 创建提供者</h4><p>9003和9004相同，改下端口号就行</p>
<p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringBoot 整合web组件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span>  <span class="comment">#配置Nacos地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把要监控的东西暴露出来</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>主启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain9003</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain9003.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller:  偷懒，用哈希表做数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟一个数据库</span></span><br><span class="line">    <span class="comment">// Payment 是自定义的那个类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Long, Payment&gt; hashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        hashMap.put(<span class="number">1L</span>,<span class="keyword">new</span> Payment(<span class="number">1L</span>,<span class="string">&quot;28a82uj2h8d92hnv&quot;</span>));</span><br><span class="line">        hashMap.put(<span class="number">2L</span>,<span class="keyword">new</span> Payment(<span class="number">2L</span>,<span class="string">&quot;bb2jdu9283nd9ch1&quot;</span>));</span><br><span class="line">        hashMap.put(<span class="number">3L</span>,<span class="keyword">new</span> Payment(<span class="number">3L</span>,<span class="string">&quot;cv87ekd0293ncf82&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        Payment payment = hashMap.get(id);</span><br><span class="line">        CommonResult&lt;Payment&gt; result = <span class="keyword">new</span> CommonResult(<span class="number">200</span>,<span class="string">&quot;from mysql,serverPort:  &quot;</span> + serverPort, payment);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：启动 nacos、sentinel、9003、9004</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926144953921.png" alt="image-20220926144953921"></p>
<h4 id="2-gt-创建消费者"><a href="#2-gt-创建消费者" class="headerlink" title="2&gt; 创建消费者"></a>2&gt; 创建消费者</h4><p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud alibaba sentinel-datasource-nacos 后续持久化使用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web + actuator--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- 引入自定义的api通用包，调实体类entities --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">84</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#Nacos 服务注册中心地址</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment">#Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描，直至找到未被占用的端口</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 消费者将要去访问的微服务名称（注册成功进nacos的微服务提供者）</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>

<p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNacosMain84</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderNacosMain84.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置类：负载均衡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<p><font color="pink">fallback 管运行异常（主业务逻辑的问题）</font></p>
<p><font color="pink">blockHandler管配置违规问题</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircleBreakerController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_URL = <span class="string">&quot;http://nacos-payment-provider&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;fallback&quot;)</span> <span class="comment">// 没有配置</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">        CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span> + id, CommonResult.class, id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Java运行时异常，因为没有id为4的数据</span></span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessException(<span class="string">&quot;IllegalAccessException,非法参数异常。。。&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="keyword">null</span>) &#123; <span class="comment">// 输1-4以外直接空指针异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;NullPointerException,该ID没有对应记录，空指针异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@SentinelResource的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;, fallback = &quot;handleFallback&quot;)</span> <span class="comment">// fallback只负责业务异常</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;, blockHandler = &quot;blockHandler&quot;)</span> <span class="comment">// blockHandler只负责sentinel可视化控制台配置违规</span></span><br></pre></td></tr></table></figure>

<p>两个结合使用（报错时各找各妈）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircleBreakerController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_URL = <span class="string">&quot;http://nacos-payment-provider&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="comment">// 两个一起用</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handleFallback&quot;, blockHandler = &quot;blockHandler&quot;)</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">        CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span> + id, CommonResult.class, id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessException(<span class="string">&quot;IllegalAccessException,非法参数异常。。。&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;NullPointerException,该ID没有对应记录，空指针异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 本例是 fallback</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">handleFallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id, Throwable e)</span> </span>&#123;</span><br><span class="line">        Payment payment = <span class="keyword">new</span> Payment(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;兜底异常handleFallback，exception内容 &quot;</span> + e.getMessage(),payment);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 本例是 blockHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">blockHandler</span><span class="params">(<span class="meta">@PathVariable</span> Long id, BlockException blockException)</span> </span>&#123;</span><br><span class="line">        Payment payment = <span class="keyword">new</span> Payment(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">445</span>,<span class="string">&quot;blockException-sentinel限流，无此流水：blockException  &quot;</span> + blockException.getMessage(),payment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Sentinel中设置熔断规则</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926152535585.png" alt="image-20220926152535585"></p>
<p>问题：如果异常同时触发 fallback 和 blockHandler；应该找谁？？</p>
<p>测试：调用 id 为4的接口，本为Java异常问题，但同时触发熔断规则</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926152832895.png" alt="image-20220926152832895"></p>
<p><font color="yellow">所以，若 fallback 和 blockHandler 都进行了配置，则被限流降级而抛出 BlockException 时只会进入 blockException 处理逻辑</font></p>
<p><font color="red">Feign系列</font></p>
<h4 id="3-gt-使用Feign调用微服务"><a href="#3-gt-使用Feign调用微服务" class="headerlink" title="3&gt; 使用Feign调用微服务"></a>3&gt; 使用Feign调用微服务</h4><p>Feign组件一般是消费侧</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926155734168.png" alt="image-20220926155734168"></p>
<p>添加pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud openfeign--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml:  激活 feign</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 激活Sentinel对feign的支持</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>主启动：添加一个注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br></pre></td></tr></table></figure>

<p>service:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Feign 就是接口加注解</span></span><br><span class="line"><span class="comment">// fallback 去找它的实现方法</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;nacos-payment-provider&quot;,fallback = PaymentFallbackService.class)</span></span><br><span class="line"><span class="comment">// 带着 Feign 注解的业务接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line">    <span class="comment">//调用 9003 和 9004的方法</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 降级的统一实现方法</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title">PaymentService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSQL</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">444444</span>,<span class="string">&quot;服务降级返回，------PaymentFallbackService&quot;</span>,<span class="keyword">new</span> Payment(id,<span class="string">&quot;ErrorSerial&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ====================OpenFeign</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/consumer/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> paymentService.paymentSQL(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926160212152.png" alt="image-20220926160212152"></p>
<p>关闭9003、9004；服务降级，不会拖垮服务器</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926160342379.png" alt="image-20220926160342379"></p>
<h4 id="4-gt-熔断框架比较"><a href="#4-gt-熔断框架比较" class="headerlink" title="4&gt; 熔断框架比较"></a>4&gt; 熔断框架比较</h4><table>
<thead>
<tr>
<th></th>
<th>Sentinel</th>
<th>Hystrix</th>
</tr>
</thead>
<tbody><tr>
<td>隔离策略</td>
<td>信号量隔离(并发线程数限流)</td>
<td>线程池隔离/信号量隔离</td>
</tr>
<tr>
<td>熔断降级策略</td>
<td>基于响应时间、异常比率、异常数</td>
<td>基于异常比率</td>
</tr>
<tr>
<td>实时统计实现</td>
<td>滑动窗口(LeapArray)</td>
<td>滑动窗口(基于RxJava)</td>
</tr>
<tr>
<td>动态规则配置</td>
<td>支持多种数据源</td>
<td>支持多种数据源</td>
</tr>
<tr>
<td>扩展性</td>
<td>多个扩展点</td>
<td>插件的形式</td>
</tr>
<tr>
<td>基于注解的支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>限流</td>
<td>基于QPS，支持基于调用关系的限流</td>
<td>有限的支持</td>
</tr>
<tr>
<td>流量整形</td>
<td>支持预热模式、匀速器模式、预热排队模式</td>
<td>不支持</td>
</tr>
<tr>
<td>系统自适应保护</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>控制台</td>
<td>提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td>
<td>简单的监控查看</td>
</tr>
</tbody></table>
<h3 id="8-规则持久化"><a href="#8-规则持久化" class="headerlink" title="8. 规则持久化"></a>8. 规则持久化</h3><p>存在问题：重启微服务后，Sentinel 规则会消失，生产环境需要将配置规则持久化</p>
<p>解决：规则配置注册进 Nacos 中</p>
<p>修改 cloudAlibaba-sentinel-service8401</p>
<p>pom：添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud alibaba sentinel-datasource-nacos 规则久化使用--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926172022503.png" alt="image-20220926172022503"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">	<span class="attr">ds1:</span></span><br><span class="line">    	<span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br></pre></td></tr></table></figure>

<p>Nacos新增配置</p>
<p><img src="/2022/09/27/SpringCloud/image-20220926171953487.png" alt="image-20220926171953487"></p>
<img src="/2022/09/27/SpringCloud/image-20220926171909231.png" alt="image-20220926171909231" style="zoom:50%;">

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;resource&quot;</span>: <span class="string">&quot;/rateLimit/byUrl&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;limitApp&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;grade&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;count&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;strategy&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;controlBehavior&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;cluserMode&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>resource：资源名称</li>
<li>limitApp：来源应用</li>
<li>grade：阈值类型，0表示线程数，1表示QPS</li>
<li>count：单机阈值</li>
<li>strategy：流控模式，0表示直接，1表示关联，2表示链路</li>
<li>controlBehavior：流控效果，0表示快速失败，1表示Warm Up，2表示排队等待</li>
<li>cluserMode：是否集群</li>
</ul>
<p>测试：启动8401，访问接口 <a target="_blank" rel="noopener" href="http://localhost:8401/rateLimit/byUrl">http://localhost:8401/rateLimit/byUrl</a></p>
<p><img src="/2022/09/27/SpringCloud/image-20220926172242332.png" alt="image-20220926172242332"></p>
<p>快速点击：规则生效<img src="/2022/09/27/SpringCloud/image-20220926172259629.png" alt="image-20220926172259629"></p>
<p><strong>重启 8401 后，再次调用接口，查看 Sentinel，规则重新出现</strong></p>
<h2 id="二十一、SpringCloud-Alibaba-Seata-处理分布式事务"><a href="#二十一、SpringCloud-Alibaba-Seata-处理分布式事务" class="headerlink" title="二十一、SpringCloud Alibaba Seata 处理分布式事务"></a>二十一、SpringCloud Alibaba Seata 处理分布式事务</h2><p>​    分布式之后，单体应用都被拆分成微服务应用，原来的三个模块被拆分成三个独立的应用，分别使用三个独立的数据源，业务操作也需要调用三个服务来完成。<font color="yellow">此时每个服务内部的数据一致性由本地事务来保证，但是全局的数据一致性就无法保证。</font></p>
<p><strong>我们需要解决的问题就是：如何保证全局数据的一致性</strong></p>
<h3 id="1-Seata-简介"><a href="#1-Seata-简介" class="headerlink" title="1. Seata 简介"></a>1. Seata 简介</h3><p>​    Seata是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事件</p>
<p>官网：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/">https://seata.io/zh-cn/</a></p>
<p><font color="pink">一个典型的分布式事务过程：分布式事务处理过程的 一ID+三组件模型</font></p>
<ul>
<li>XID：全局唯一的事务ID</li>
<li>3组件概念<ol>
<li>TC——-事务协调者：维护全局和分支事务的状态，驱动全局事务提交或回滚</li>
<li>TM——-事务管理器：定义全局事务的范围：开始全局事务、提交或回滚全局事务</li>
<li>RM——-资源管理器：管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务的提交或回滚</li>
</ol>
</li>
</ul>
<p><font color="pink">处理过程：</font></p>
<p><img src="/2022/09/27/SpringCloud/image-20220927101736657.png" alt="image-20220927101736657"></p>
<ol>
<li><p>TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID</p>
<p>（各个班的班主任TM向授课老师TC申请一个班级号）</p>
</li>
<li><p>XID 在微服务调用链路的上下文中传播</p>
<p>（班级号在学生们之间传播，让他们加入班级）</p>
</li>
<li><p>RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖</p>
<p>（学生们加入授课老师的课堂，授课老师可以统一看到所有学生）</p>
</li>
<li><p>TM 向 TC 发起针对 XID 的全局提交或回滚协议</p>
<p>（班主任发起签到，然后告诉老师可以上课了；老师可以屏幕共享到所有学生）</p>
</li>
<li><p>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求</p>
<p>（下课休息，告知全部学生）</p>
</li>
</ol>
    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/22/mybatis-plus/" rel="prev" title="">
      <i class="fa fa-chevron-left"></i> 
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">一、基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-SpringCloud%E7%AE%80%E4%BB%8B"><span class="nav-text">1.SpringCloud简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%8A%80%E6%9C%AF"><span class="nav-text">2.基本使用技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%89%88%E6%9C%AC%E9%80%89%E6%8B%A9"><span class="nav-text">3.版本选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%95%99%E7%A8%8B%E4%BD%BF%E7%94%A8%E7%89%88%E6%9C%AC"><span class="nav-text">4.教程使用版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E7%BB%84%E4%BB%B6%E5%81%9C%E6%9B%B4%E8%AF%B4%E6%98%8E"><span class="nav-text">5.组件停更说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringCloud-%E4%B8%AD%E6%96%87%E7%9F%A5%E9%81%93%E6%89%8B%E5%86%8C"><span class="nav-text">SpringCloud 中文知道手册</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E8%81%9A%E5%90%88%E7%88%B6%E5%B7%A5%E7%A8%8B"><span class="nav-text">二、聚合父工程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%88%B6%E5%B7%A5%E7%A8%8Bpom%E6%96%87%E4%BB%B6"><span class="nav-text">父工程pom文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%9E%84%E5%BB%BA%E6%94%AF%E4%BB%98%E6%A8%A1%E5%9D%97"><span class="nav-text">三、构建支付模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%BB%BAmoudle"><span class="nav-text">1. 建moudle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%94%B9%E5%AD%90%E7%B1%BB%E7%9A%84pom"><span class="nav-text">2. 改子类的pom</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%85%8D%E7%BD%AEyml%E6%96%87%E4%BB%B6-%E8%87%AA%E5%B7%B1%E6%96%B0%E5%BB%BA"><span class="nav-text">3. 配置yml文件(自己新建)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%86%99%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="nav-text">4. 写启动类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="nav-text">5.业务类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E7%83%AD%E9%83%A8%E7%BD%B2Devtools"><span class="nav-text">6.热部署Devtools</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88%E5%9C%A8cloud%E4%B8%8B%E5%88%9B%E5%BB%BA%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%B7%A5%E7%A8%8B%EF%BC%89"><span class="nav-text">四、客户端（在cloud下创建另一个工程）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%BF%98%E6%98%AF%E8%80%81%E6%A0%B7%E5%AD%90%EF%BC%8C5%E6%AD%A5%E8%B5%B0"><span class="nav-text">1. 还是老样子，5步走</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%85%8D%E7%BD%AERestTemplat"><span class="nav-text">2. 配置RestTemplat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="nav-text">3. 业务类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%90%AF%E5%8A%A8%E5%A4%9A%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-text">4. 启动多个微服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%B7%A5%E7%A8%8B%E9%87%8D%E6%9E%84"><span class="nav-text">五、工程重构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%97%AE%E9%A2%98"><span class="nav-text">1. 问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BA%E6%96%B0-moudle"><span class="nav-text">2. 创建新 moudle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%94%B9-pom-%E4%BE%9D%E8%B5%96"><span class="nav-text">3. 改 pom 依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8A%8Aentities%E7%B2%98%E8%B4%B4%E8%BF%87%E6%9D%A5"><span class="nav-text">4. 把entities粘贴过来</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-maven%E5%91%BD%E4%BB%A4-clean%EF%BC%8Cinstall"><span class="nav-text">5. maven命令 clean，install</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%88%A0%E9%99%A48001%E3%80%818002%E4%B8%A4%E4%B8%AA%E9%A1%B9%E7%9B%AE%E7%9A%84entities%EF%BC%9B%E5%B9%B6%E5%9C%A8%E5%90%84%E8%87%AApom%E4%B8%AD%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-text">6. 删除8001、8002两个项目的entities；并在各自pom中导入依赖</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81-Eureka-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="nav-text">六、 Eureka 服务注册与发现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81-Eureka%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">1、 Eureka基础知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81-%E5%8D%95%E6%9C%BA%E7%89%88Eureka%E6%9E%84%E5%BB%BA"><span class="nav-text">2、 单机版Eureka构建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-gt-IDEA%E7%94%9F%E6%88%90-eurekaServer%E7%AB%AF%E6%9C%8D%E5%8A%A1%E4%B8%AD%E5%BF%83"><span class="nav-text">1&gt; IDEA生成 eurekaServer端服务中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-gt-payment8001%E6%B3%A8%E5%86%8C%E8%BF%9BeurekaServer"><span class="nav-text">2&gt; payment8001注册进eurekaServer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-gt-consmer8002%E6%B3%A8%E5%86%8C%E8%BF%9BeurekaServer"><span class="nav-text">3&gt; consmer8002注册进eurekaServer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81-%E9%9B%86%E7%BE%A4Eureka%E6%9E%84%E5%BB%BA"><span class="nav-text">3、 集群Eureka构建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-gt-%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86"><span class="nav-text">1&gt; 集群原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-gt-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">2&gt; 集群环境搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-gt-%E6%8A%8A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0-Eureka-%E9%9B%86%E7%BE%A4%E4%B8%AD"><span class="nav-text">3&gt; 把微服务注册到 Eureka 集群中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-gt-%E6%B5%8B%E8%AF%95-01"><span class="nav-text">4&gt; 测试-01</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-gt-%E6%90%AD%E5%BB%BA%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%9B%86%E7%BE%A4%EF%BC%88%E6%94%AF%E4%BB%98%E8%80%85%EF%BC%89"><span class="nav-text">5&gt; 搭建服务端集群（支付者）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-gt-actuator%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%A1%E6%81%AF%E5%AE%8C%E5%96%84"><span class="nav-text">6&gt;  actuator微服务信息完善</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-gt-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-discovery"><span class="nav-text">7&gt;  服务发现 discovery</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-gt-Eureka-%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6"><span class="nav-text">8&gt; Eureka 自我保护机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-gt-%E5%85%B3%E9%97%AD%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6"><span class="nav-text">9&gt;  关闭自我保护机制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81-Zookeeper%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="nav-text">七、 Zookeeper注册与发现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83zookeeper"><span class="nav-text">1.  注册中心zookeeper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="nav-text">2. 服务提供者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-text">3.  服务消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81-Consul%E6%B3%A8%E5%86%8C"><span class="nav-text">八、 Consul注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Consul%E7%AE%80%E4%BB%8B"><span class="nav-text">1. Consul简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Consul-%E4%B8%8B%E8%BD%BD%E5%92%8C%E5%AE%89%E8%A3%85"><span class="nav-text">2. Consul 下载和安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E6%B3%A8%E5%86%8C%E8%BF%9Bconsul"><span class="nav-text">3.  服务提供者注册进consul</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E6%B3%A8%E5%86%8C%E8%BF%9Bconsul"><span class="nav-text">4. 服务消费者注册进consul</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81-%E4%B8%89%E7%A7%8D%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%BC%82%E5%90%8C%E7%82%B9"><span class="nav-text">九、 三种注册中心的异同点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="nav-text">十、Ribbon负载均衡服务调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="nav-text">1. 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%80%8E%E4%B9%88%E7%94%A8"><span class="nav-text">2. 怎么用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RestTemplate%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">RestTemplate的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Ribbon-%E9%BB%98%E8%AE%A4%E7%9A%84%E8%B4%9F%E8%BD%BD%E8%A7%84%E5%88%99"><span class="nav-text">3. Ribbon 默认的负载规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%9B%BF%E6%8D%A2Ribbon%E7%9A%84%E8%A7%84%E5%88%99"><span class="nav-text">4. 替换Ribbon的规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E8%BD%AE%E8%AF%A2%E8%A7%84%E5%88%99%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-text">5. 轮询规则的原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%89%8B%E5%86%99%E8%BD%AE%E8%AF%A2%E7%AE%97%E6%B3%95"><span class="nav-text">6. 手写轮询算法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81OpenFeign%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="nav-text">十一、OpenFeign的服务调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="nav-text">1. 使用步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-OpenFeign-%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="nav-text">2. OpenFeign 超时控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-OpenFeign-%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%8A%9F%E8%83%BD"><span class="nav-text">3. OpenFeign 日志打印功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81-Hystrix-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E5%99%A8"><span class="nav-text">十二、 Hystrix 服务熔断器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Hystrix%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="nav-text">1. Hystrix重要概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9E%84%E5%BB%BA"><span class="nav-text">2. 构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B5%8B%E8%AF%95"><span class="nav-text">3. 高并发测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%96%B0%E5%BB%BA%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%8A%A0%E5%85%A5"><span class="nav-text">4. 新建消费端加入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="nav-text">5. 服务降级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8001-fallback"><span class="nav-text">8001 fallback</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#890-fallback"><span class="nav-text">890 fallback</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98"><span class="nav-text">存在问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="nav-text">6. 服务熔断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-Hystrix-Dashboard"><span class="nav-text">7. Hystrix Dashboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3-gateway"><span class="nav-text">十三、服务网关 gateway</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-gateway%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">1. gateway三大核心概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="nav-text">2. 基本配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-gateway%E9%85%8D%E7%BD%AE%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="nav-text">3. gateway配置动态路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Predicate%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">4. Predicate的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-gateway%E7%9A%84Filter%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">5. gateway的Filter的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gateway%E5%B0%8F%E7%BB%93"><span class="nav-text">gateway小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81-SpringCloud-Config-%E5%88%86%E9%85%8D%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-text">十四、 SpringCloud Config 分配式配置中心</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%94%E3%80%81-SpringCloud-Bus%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF"><span class="nav-text">十五、 SpringCloud Bus消息总线</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85RabbitMQ"><span class="nav-text">安装RabbitMQ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%85%AD%E3%80%81-SpringCloud-Stream-%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8"><span class="nav-text">十六、 SpringCloud Stream 消息驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Stream%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B%E5%A5%97%E8%B7%AF"><span class="nav-text">1. Stream标准流程套路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-text">2. 消息驱动生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-text">3. 消息驱动消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%88%86%E7%BB%84%E6%B6%88%E8%B4%B9%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96-%E9%87%8D%E8%A6%81"><span class="nav-text">4. 分组消费与持久化 重要*</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%83%E3%80%81-SpringCloud-Sleuth-%E5%88%86%E5%B8%83%E5%BC%8F%E8%AF%B7%E6%B1%82%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA"><span class="nav-text">十七、 SpringCloud Sleuth 分布式请求链路跟踪</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%85%AB%E3%80%81-SpringCloud-Alibaba%E7%AE%80%E4%BB%8B"><span class="nav-text">十八、 SpringCloud Alibaba简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B9%9D%E3%80%81-SpringCloud-Alibaba-Nacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-text">十九、 SpringCloud Alibaba Nacos服务注册和配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%8B%E8%BD%BD%E5%92%8C%E5%AE%89%E8%A3%85"><span class="nav-text">1. 下载和安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Nacos-%E4%BD%9C%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-text">2. Nacos 作服务注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-gt-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="nav-text">1&gt; 服务提供者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-gt-%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-text">2&gt; 服务消费者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-gt-Nacos-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AF%B9%E6%AF%94"><span class="nav-text">3&gt; Nacos 注册中心对比</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Nacos-%E4%BD%9C%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-text">3. Nacos 作服务配置中心</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Nacos-%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-text">4. Nacos 多环境配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-gt-DataID%E9%85%8D%E7%BD%AE"><span class="nav-text">1&gt; DataID配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-gt-Group-%E5%88%86%E7%BB%84"><span class="nav-text">2&gt; Group 分组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-gt-Namespace"><span class="nav-text">3&gt; Namespace</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Nacos-%E9%9B%86%E7%BE%A4%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96-%E9%87%8D%E8%A6%81"><span class="nav-text">5. Nacos 集群和持久化(重要)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E3%80%81-SpringCloud-Alibaba-Sentinel-%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81"><span class="nav-text">二十、 SpringCloud Alibaba Sentinel 实现熔断和限流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%BC%94%E7%A4%BA%E5%B7%A5%E7%A8%8B"><span class="nav-text">1. 演示工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="nav-text">2. 流控规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="nav-text">3. 流控效果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="nav-text">4. 熔断规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Sentinel-%E7%83%AD%E7%82%B9key"><span class="nav-text">5. Sentinel 热点key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-SentinelResource"><span class="nav-text">6. @SentinelResource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-Sentinel-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="nav-text">7. Sentinel 服务熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-gt-%E5%88%9B%E5%BB%BA%E6%8F%90%E4%BE%9B%E8%80%85"><span class="nav-text">1&gt; 创建提供者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-gt-%E5%88%9B%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-text">2&gt; 创建消费者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-gt-%E4%BD%BF%E7%94%A8Feign%E8%B0%83%E7%94%A8%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-text">3&gt; 使用Feign调用微服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-gt-%E7%86%94%E6%96%AD%E6%A1%86%E6%9E%B6%E6%AF%94%E8%BE%83"><span class="nav-text">4&gt; 熔断框架比较</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">8. 规则持久化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%80%E3%80%81SpringCloud-Alibaba-Seata-%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">二十一、SpringCloud Alibaba Seata 处理分布式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Seata-%E7%AE%80%E4%BB%8B"><span class="nav-text">1. Seata 简介</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="散人阿畅"
      src="/images/%E7%BD%97%E5%B0%8F%E9%BB%91.jpg">
  <p class="site-author-name" itemprop="name">散人阿畅</p>
  <div class="site-description" itemprop="description">浮舟沧海，立马昆仑</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/" title="GitHub → https:&#x2F;&#x2F;github.com" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/yourname" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">散人阿畅</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"live2d-widget-model-wankohexo"},"display":{"position":"right","width":70,"height":120},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
